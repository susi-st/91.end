<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>九年級資訊科技 - 期末適性評量</title>
    
    <!-- 1. 引入 Tailwind CSS (樣式) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 引入 React 和 ReactDOM (核心) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. 引入 Babel (讓瀏覽器看懂 JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 自定義樣式調整 -->
    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .option-btn {
            transition: all 0.2s ease;
        }
        .option-btn:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        // --- 圖示元件定義 ---
        const Icons = {
            CheckCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            AlertCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            ArrowRight: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>,
            BookOpen: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
            Calculator: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>,
            Layout: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" x2="21" y1="9" y2="9"/><line x1="9" x2="9" y1="21" y2="9"/></svg>,
            Award: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>,
            Send: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            Lock: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Star: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
            Heart: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>,
            Cloud: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>,
            Smile: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>,
            PenTool: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg>,
            MessageCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>,
            EyeOff: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>,
            Info: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></svg>,
            X: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>,
        };

        const { useState, useEffect } = React;
        const { CheckCircle, AlertCircle, ArrowRight, BookOpen, Calculator, Layout, Award, Send, Lock, Star, Heart, Cloud, Smile, PenTool, MessageCircle, EyeOff, Info, X } = Icons;

        // --- 應用程式邏輯 ---
        
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzpZuCMZXJMAeu5EgcWCQROj8k-b7FMXDRTqlxZRI65sTtJJmGJ4dcGj7lq74iuxni9/exec"; 
        
        const DIMENSIONS = {
            CONCEPT: 'concept',
            COMPUTATION: 'computation',
            APPLICATION: 'application'
        };

        const FEEDBACK_LIBRARY = {
            [DIMENSIONS.CONCEPT]: {
                A: "你在資訊科技的邏輯理解上表現卓越！不僅能精確掌握資料數位化（取樣與量化）的核心原理，也能清楚區分點陣與向量圖的差異。",
                B: "本學期你對電腦運作原理已有穩固的基礎，能理解現實世界的聲音與影像如何轉換為電腦中的 0 與 1，但在細節原理的解釋上可以更精確。",
                C: "你已經建立了電腦使用 0 與 1 儲存資料的基本概念。建議在數位化原理（如聲音的取樣過程）多花點時間複習，釐清取樣與量化的差異。"
            },
            [DIMENSIONS.COMPUTATION]: {
                A: "在二進位運算與檔案容量估算上展現了嚴謹的運算思維，能靈活運用公式計算未壓縮音訊大小，並正確進行單位的換算。",
                B: "在進位制轉換計算上大致正確，唯在複雜的單位換算（如 bits 轉 MB）細節上可再細心一點，公式運用尚稱熟練。",
                C: "建議多練習二進位的計算規則，並試著搞懂 Bit 與 Byte 的倍數差異，這對於未來評估手機或電腦容量非常重要。"
            },
            [DIMENSIONS.APPLICATION]: {
                A: "你對於不同文字編碼（Unicode/Big-5）與影像格式的特性瞭若指掌，能針對不同需求做出最佳的技術選擇，具備優秀的數位公民素養。",
                B: "對於常見的檔案格式（JPG, MP3）有基本認識，若能進一步深究不同編碼系統（如亂碼原因）的差異，你的資訊素養將更上一層樓。",
                C: "對於檔案格式的用途與文字編碼的概念較為模糊，建議多觀察生活中的檔案附檔名，將有助於理解這些數位工具的特性。"
            }
        };

        const QUIZ_DATA = [
            // 單元 1: 聲音數位化原理 (基礎)
            {
                id: 'c1',
                title: '聲音數位化：取樣與格式',
                dimension: DIMENSIONS.CONCEPT,
                questions: [
                    { id: 'q1-1', type: 'MC', text: '一般電話的通話取樣頻率是 8kHz，代表 1 秒鐘要進行幾次取樣？', options: ['8,000 次', '8 次', '800 次', '80,000 次'], correctAnswer: '8,000 次' },
                    { id: 'q1-2', type: 'MC', text: '同一段聲音，以下列何種格式錄製，它的檔案最大 (未經壓縮)？', options: ['WAV(.wav)', 'MIDI(.mid)', 'MP3(.mp3)', 'DOC(.doc)'], correctAnswer: 'WAV(.wav)' },
                    { id: 'q1-3', type: 'TF', text: '「取樣」是指將連續的類比訊號，在時間軸上切割成不連續的點。', options: ['正確', '錯誤'], correctAnswer: '正確' } // Check
                ]
            },
            // 單元 2: 聲音數位化原理 (進階)
            {
                id: 'c2',
                title: '聲音數位化：品質與量化',
                dimension: DIMENSIONS.CONCEPT,
                questions: [
                    { id: 'q2-1', type: 'MC', text: '若要提高錄音的品質，使其更接近原音，應該如何調整？', options: ['提高取樣頻率與解析度', '降低取樣頻率與解析度'], correctAnswer: '提高取樣頻率與解析度' },
                    { id: 'q2-2', type: 'MC', text: '關於「量化」的敘述，下列何者正確？', options: ['量化是紀錄波形的振幅數值', '量化是紀錄時間的長短'], correctAnswer: '量化是紀錄波形的振幅數值' },
                    { id: 'q2-3', type: 'MC', text: '若要計算未壓縮聲音檔的大小，公式中「不需要」包含下列哪一項？', options: ['錄音時間長度', '麥克風的廠牌'], correctAnswer: '麥克風的廠牌' } // Check
                ]
            },
            // 單元 3: 影像數位化 (基礎)
            {
                id: 'c3',
                title: '數位影像：向量與點陣',
                dimension: DIMENSIONS.CONCEPT,
                questions: [
                    { id: 'q3-1', type: 'MC', text: '請問以「數學公式」記錄影像資訊的為下列何種影像類型？(放大不失真)', options: ['向量圖', '點陣圖', '柏拉圖', '西雅圖'], correctAnswer: '向量圖' },
                    { id: 'q3-2', type: 'TF', text: '「向量圖」放大後邊緣會產生鋸齒狀的失真，不適合用於大圖輸出。', options: ['正確', '錯誤'], correctAnswer: '錯誤' },
                    { id: 'q3-3', type: 'MC', text: '手機拍出來的照片，通常是屬於哪一種類型的圖檔？', options: ['點陣圖 (Bitmap)', '向量圖 (Vector)'], correctAnswer: '點陣圖 (Bitmap)' } // Check
                ]
            },
            // 單元 4: 影像數位化 (運算)
            {
                id: 'c4',
                title: '數位影像：解析度與色彩',
                dimension: DIMENSIONS.COMPUTATION,
                questions: [
                    { id: 'q4-1', type: 'MC', text: '若將 4x6 的照片，用掃描器以 300DPI 進行數位化，請問其數位化後的影像「長邊」會是多少 Dots (像素)？', options: ['1800', '1200', '75', '50'], correctAnswer: '1800' },
                    { id: 'q4-2', type: 'MC', text: '請問彩色影像如果以 8 位元來記錄每一種色光 (R, G, B)，那麼畫面中的每一個像素會使用多少位元來表示色彩？', options: ['24 位元', '8 位元', '32 位元', '16 位元'], correctAnswer: '24 位元' },
                    { id: 'q4-3', type: 'MC', text: '哪一種圖檔是透過數學公式來紀錄圖形的形狀與顏色？', options: ['向量圖', '點陣圖'], correctAnswer: '向量圖' } // Check
                ]
            },
            // 單元 5: 資料表示 (基礎運算)
            {
                id: 'c5',
                title: '資料表示：基礎二進位',
                dimension: DIMENSIONS.COMPUTATION,
                questions: [
                    { id: 'q5-1', type: 'TF', text: '電腦內部處理資料時，主要是使用「十進位」系統。', options: ['正確', '錯誤'], correctAnswer: '錯誤' },
                    { id: 'q5-2', type: 'MC', text: '十進位的數字「3」，轉換成二進位是多少？', options: ['11', '10', '00', '01'], correctAnswer: '11' },
                    { id: 'q5-3', type: 'MC', text: '二進位的「100」，轉換成十進位是多少？', options: ['4', '8'], correctAnswer: '4' } // Check
                ]
            },
            // 單元 6: 資料表示 (進階運算)
            {
                id: 'c6',
                title: '資料表示：進階運算',
                dimension: DIMENSIONS.COMPUTATION,
                questions: [
                    { id: 'q6-1', type: 'MC', text: '(10010)₂，換算成十進位是多少？', options: ['18', '12', '20', '16'], correctAnswer: '18' },
                    { id: 'q6-2', type: 'MC', text: '正整數 9 經過數位化後，若以「8 位元」的格式來表示，應該會是多少？', options: ['00001001', '1001', '10010000', '00001010'], correctAnswer: '00001001' },
                    { id: 'q6-3', type: 'MC', text: '1 Byte (位元組) 等於多少 bits (位元)？', options: ['8 bits', '10 bits'], correctAnswer: '8 bits' } // Check
                ]
            },
            // 單元 7: 系統應用 (編碼)
            {
                id: 'c7',
                title: '系統應用：編碼原理',
                dimension: DIMENSIONS.APPLICATION,
                questions: [
                    { id: 'q7-1', type: 'MC', text: '請問以下哪一個編碼系統的推出，是為了讓電腦能同時處理多國語言混用的情況 (解決亂碼)？', options: ['Unicode', 'ASCII', 'Big-5', 'ANSI-8'], correctAnswer: 'Unicode' },
                    { id: 'q7-2', type: 'MC', text: '若網頁出現亂碼，通常是因為哪兩種編碼系統衝突？', options: ['Big-5 與 Unicode', 'RGB 與 CMYK', 'Windows 與 MacOS', 'JPG 與 GIF'], correctAnswer: 'Big-5 與 Unicode' },
                    { id: 'q7-3', type: 'MC', text: '想要製作背景透明的圖示，應該選擇哪種檔案格式？', options: ['PNG', 'JPG'], correctAnswer: 'PNG' } // Check
                ]
            },
            // 單元 8: 綜合觀念
            {
                id: 'c8',
                title: '綜合觀念與儲存',
                dimension: DIMENSIONS.APPLICATION,
                questions: [
                    { id: 'q8-1', type: 'TF', text: '在儲存單位中，1 GB 的容量比 1 MB 還要小。', options: ['正確', '錯誤'], correctAnswer: '錯誤' },
                    { id: 'q8-2', type: 'MC', text: 'RGB 色彩模式中，(255, 255, 255) 代表什麼顏色？', options: ['黑色', '白色'], correctAnswer: '白色' },
                    { id: 'q8-3', type: 'MC', text: '下列何者是電腦儲存資料的最小單位？', options: ['Bit (位元)', 'Byte (位元組)', 'KG', 'KM'], correctAnswer: 'Bit (位元)' } // Check
                ]
            }
        ];

        const SURVEY_QUESTIONS = [
            { id: 's1', icon: <Smile size={24}/>, text: '我上課能專心參與', options: ['總是做到', '經常做到', '偶爾做到', '較少做到'] },
            { id: 's2', icon: <PenTool size={24}/>, text: '我能完成當次作業', options: ['總是做到', '經常做到', '偶爾做到', '較少做到'] },
            { id: 's3', icon: <MessageCircle size={24}/>, text: '遇到問題，我會問老師', options: ['總是做到', '經常做到', '偶爾做到', '較少做到'] }
        ];

        const generateRandomId = () => Math.floor(10000 + Math.random() * 90000).toString();

        const formatTime = (seconds) => {
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}分${s}秒`;
        };

        // 選項處理函式
        const manipulateOptions = (array) => {
            if (array.length === 2) {
                return [array[1], array[0]];
            }
            // Fisher-Yates Shuffle
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        };

        // 題目映射 (ID -> 序號)
        const getQuestionNumberMap = () => {
            const map = {};
            let count = 1;
            QUIZ_DATA.forEach(c => {
                c.questions.forEach(q => {
                    map[q.id] = count++;
                });
            });
            return map;
        };

        const STORAGE_KEY = 'ninth_grade_assessment_v9'; // 更新版本號

        // 簡單的無痕模式偵測
        const detectIncognito = async () => {
            try {
                if ('storage' in navigator && 'estimate' in navigator.storage) {
                    const { usage, quota } = await navigator.storage.estimate();
                    if (quota < 120000000) return true;
                }
                return false;
            } catch(e) {
                return false;
            }
        };

        function AssessmentApp() {
            const [currentStep, setCurrentStep] = useState('loading'); 
            const [currentConceptIndex, setCurrentConceptIndex] = useState(0);
            const [questionSequence, setQuestionSequence] = useState([]); 
            const [currentQuestionIdx, setCurrentQuestionIdx] = useState(0);
            const [answers, setAnswers] = useState({});
            const [scores, setScores] = useState({});
            const [speedViolations, setSpeedViolations] = useState({});
            
            const [startTime, setStartTime] = useState(null); 
            const [endTime, setEndTime] = useState(null);
            const [questionStartTime, setQuestionStartTime] = useState(null); 
            
            const [userInfo, setUserInfo] = useState({ className: '1', seatNumber: '' });
            const [surveyAnswers, setSurveyAnswers] = useState({});
            const [randomId, setRandomId] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [submitError, setSubmitError] = useState('');
            const [alreadyCompleted, setAlreadyCompleted] = useState(false);
            const [storedFeedback, setStoredFeedback] = useState([]); 
            
            const [isIncognito, setIsIncognito] = useState(false);
            const [isDuplicate, setIsDuplicate] = useState(false);
            const [showDuplicateModal, setShowDuplicateModal] = useState(false);

            useEffect(() => {
                const init = async () => {
                    const incognito = await detectIncognito();
                    if (incognito) {
                        setIsIncognito(true);
                        setCurrentStep('incognito_blocked');
                        return;
                    }

                    const savedData = localStorage.getItem(STORAGE_KEY);
                    if (savedData) {
                        try {
                            const parsedData = JSON.parse(savedData);
                            if (parsedData.completed) {
                                setRandomId(parsedData.randomId || '');
                                setUserInfo(parsedData.userInfo || { className: '1', seatNumber: '' });
                                setStoredFeedback(parsedData.feedbackList || []);
                                
                                setAlreadyCompleted(true);
                                setIsDuplicate(true);
                                setShowDuplicateModal(true);
                                setCurrentStep('result');
                                return;
                            }
                        } catch (e) {
                            console.error("Local storage parse error", e);
                            localStorage.removeItem(STORAGE_KEY);
                        }
                    }
                    setCurrentStep('intro');
                };
                init();
            }, []);

            useEffect(() => {
                if (currentStep === 'quiz' && questionSequence.length > 0) {
                    setQuestionStartTime(Date.now());
                }
            }, [currentQuestionIdx, currentStep, questionSequence]);

            useEffect(() => {
                if (currentStep === 'quiz' && currentConceptIndex === 0 && currentQuestionIdx === 0 && !startTime) {
                    setStartTime(Date.now());
                }
                if (currentStep === 'quiz') {
                    loadConcept(currentConceptIndex || 0);
                }
            }, [currentStep]);

            const loadConcept = (index) => {
                if (index >= QUIZ_DATA.length) {
                    setCurrentStep('survey');
                    return;
                }
                setCurrentConceptIndex(index);
                const concept = QUIZ_DATA[index];
                if (questionSequence.length === 0 || QUIZ_DATA[index].id !== QUIZ_DATA[currentConceptIndex]?.id) {
                    setQuestionSequence([concept.questions[0], concept.questions[1]]);
                    setCurrentQuestionIdx(0);
                }
            };

            const handleAnswer = (option) => {
                const now = Date.now();
                const timeSpent = now - questionStartTime;
                const currentConcept = QUIZ_DATA[currentConceptIndex];
                const currentQ = questionSequence[currentQuestionIdx];
                
                let isCorrect = false;

                if (timeSpent < 4000) {
                    isCorrect = false; 
                    setSpeedViolations(prev => ({
                        ...prev,
                        [currentConcept.dimension]: true
                    }));
                } else {
                    isCorrect = (option === currentQ.correctAnswer);
                }

                const newAnswers = { ...answers, [currentQ.id]: isCorrect };
                setAnswers(newAnswers);

                if (currentQuestionIdx === 1) { 
                    const q1Result = newAnswers[currentConcept.questions[0].id];
                    const q2Result = isCorrect;
                    
                    let nextSequence = [...questionSequence];
                    
                    if (q1Result !== q2Result) {
                        nextSequence.push(currentConcept.questions[2]); 
                        setQuestionSequence(nextSequence);
                        setCurrentQuestionIdx(currentQuestionIdx + 1);
                    } else {
                        goToNextConcept(currentConcept.id, newAnswers, nextSequence);
                    }
                } else if (currentQuestionIdx >= questionSequence.length - 1) { 
                    goToNextConcept(currentConcept.id, newAnswers, questionSequence);
                } else {
                    setCurrentQuestionIdx(currentQuestionIdx + 1);
                }
            };

            const goToNextConcept = (conceptId, currentAnswers, sequence) => {
                let correctCount = 0;
                const uniqueQuestions = new Map();
                sequence.forEach(q => uniqueQuestions.set(q.id, q));

                uniqueQuestions.forEach((q, id) => {
                    if (currentAnswers[id]) correctCount++;
                });

                setScores(prev => ({
                    ...prev,
                    [conceptId]: { correct: correctCount, total: uniqueQuestions.size }
                }));

                setQuestionSequence([]); 
                setCurrentQuestionIdx(0);
                loadConcept(currentConceptIndex + 1);
            };

            const handleSurveyAnswer = (questionId, option) => {
                setSurveyAnswers(prev => ({
                    ...prev,
                    [questionId]: option
                }));
            };
            
            const finishSurvey = () => {
                if (Object.keys(surveyAnswers).length < SURVEY_QUESTIONS.length) {
                    alert("請完成所有問題喔！");
                    return;
                }
                setEndTime(Date.now());
                setCurrentStep('submission');
            };

            const generateFeedbackData = () => {
                let dimensionScores = {
                    [DIMENSIONS.CONCEPT]: { correct: 0, total: 0 },
                    [DIMENSIONS.COMPUTATION]: { correct: 0, total: 0 },
                    [DIMENSIONS.APPLICATION]: { correct: 0, total: 0 }
                };

                QUIZ_DATA.forEach(concept => {
                    const score = scores[concept.id];
                    if (score) {
                        dimensionScores[concept.dimension].correct += score.correct;
                        dimensionScores[concept.dimension].total += score.total;
                    }
                });

                const feedbackList = Object.values(DIMENSIONS).map(dim => {
                    const { correct, total } = dimensionScores[dim] || { correct: 0, total: 0 };
                    const percentage = total === 0 ? 0 : (correct / total);
                    let level = 'C';
                    if (percentage >= 0.8) level = 'A';
                    else if (percentage >= 0.5) level = 'B';
                    
                    let title = "";
                    if(dim === DIMENSIONS.CONCEPT) title = "一、數位化原理的理解";
                    if(dim === DIMENSIONS.COMPUTATION) title = "二、運算思維與數值轉換";
                    if(dim === DIMENSIONS.APPLICATION) title = "三、系統應用與編碼素養";

                    let feedbackText = FEEDBACK_LIBRARY[dim][level];

                    if (speedViolations[dim]) {
                        feedbackText = "答題速度過快，難以評斷";
                    }

                    return {
                        dim,
                        title,
                        level,
                        text: feedbackText
                    };
                });

                return feedbackList;
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!userInfo.seatNumber) {
                    alert("請輸入座號！");
                    return;
                }

                setIsSubmitting(true);
                setSubmitError('');

                const feedbackList = generateFeedbackData();
                const generatedRandomId = generateRandomId();
                const durationSeconds = (endTime - startTime) / 1000;
                const formattedTime = formatTime(durationSeconds);
                const teacherSummaryText = "在九年級這個階段，評量的核心不應只是「算對數學題」，而是「連結真實世界」。希望你現在已經懂得為什麼 3 分鐘的未壓縮錄音檔會這麼大，以及為什麼我們需要 MP3 格式來壓縮它。";

                const surveyText = SURVEY_QUESTIONS.map(q => `[反思] ${q.text}：${surveyAnswers[q.id] || ''}`).join("\n");
                const fullFeedbackText = feedbackList.map(f => `[${f.title}] ${f.text}`).join("\n") + "\n\n" + surveyText;

                // 準備答對/答錯題號列表
                const qMap = getQuestionNumberMap();
                const correctList = Object.keys(answers)
                    .filter(id => answers[id])
                    .map(id => qMap[id])
                    .sort((a, b) => a - b)
                    .join(", ");
                const incorrectList = Object.keys(answers)
                    .filter(id => !answers[id])
                    .map(id => qMap[id])
                    .sort((a, b) => a - b)
                    .join(", ");

                const payload = {
                    className: `九年${userInfo.className}班`,
                    seatNumber: userInfo.seatNumber,
                    conceptLevel: feedbackList.find(f => f.dim === DIMENSIONS.CONCEPT)?.level,
                    computationLevel: feedbackList.find(f => f.dim === DIMENSIONS.COMPUTATION)?.level,
                    applicationLevel: feedbackList.find(f => f.dim === DIMENSIONS.APPLICATION)?.level,
                    feedbackText: fullFeedbackText,
                    teacherSummary: teacherSummaryText,
                    totalTime: formattedTime,
                    randomId: generatedRandomId,
                    correctQuestions: correctList,
                    incorrectQuestions: incorrectList
                };

                try {
                    if (!isDuplicate && GOOGLE_SCRIPT_URL) {
                        await fetch(GOOGLE_SCRIPT_URL, {
                            method: 'POST',
                            mode: 'no-cors', 
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                    } else {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }

                    setRandomId(generatedRandomId);
                    setStoredFeedback(feedbackList);
                    
                    localStorage.setItem(STORAGE_KEY, JSON.stringify({
                        completed: true,
                        randomId: generatedRandomId,
                        userInfo: userInfo,
                        feedbackList: feedbackList
                    }));

                    setCurrentStep('result');

                } catch (error) {
                    console.error("Submission Error:", error);
                    setSubmitError("資料傳送失敗，請檢查網路連線或稍後再試。");
                } finally {
                    setIsSubmitting(false);
                }
            };

            // --- Render (同前，略) ---
            if (currentStep === 'incognito_blocked') {
                return (
                    <div className="min-h-screen bg-gray-900 flex flex-col items-center justify-center p-6 text-center font-sans">
                        <div className="bg-gray-800 p-8 rounded-3xl border-2 border-red-500 shadow-2xl max-w-md w-full">
                            <div className="text-red-500 mb-6 flex justify-center"><EyeOff size={64} /></div>
                            <h1 className="text-2xl font-bold text-white mb-4">無法在無痕模式中進行評量</h1>
                            <p className="text-gray-400">系統偵測到您正在使用「無痕模式」或「私密瀏覽」。<br/><br/>請關閉此視窗，使用<strong>一般模式</strong>重新開啟網頁以進行測驗。</p>
                        </div>
                    </div>
                );
            }

            if (currentStep === 'loading') {
                return <div className="min-h-screen flex items-center justify-center bg-pink-50 text-gray-500 font-medium">✨ 準備中...</div>;
            }

            if (currentStep === 'intro') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-pink-100 via-purple-100 to-sky-100 flex items-center justify-center p-4 font-sans">
                        <div className="bg-white/90 backdrop-blur max-w-2xl w-full rounded-[3rem] shadow-xl overflow-hidden border-4 border-white">
                            <div className="bg-rose-400 p-10 text-white text-center relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-20 h-20 bg-white/20 rounded-full -translate-x-10 -translate-y-10"></div>
                                <div className="absolute bottom-0 right-0 w-32 h-32 bg-white/10 rounded-full translate-x-10 translate-y-10"></div>
                                <h1 className="text-3xl font-bold mb-3 tracking-wide drop-shadow-md">九年級資訊科技</h1>
                                <h2 className="text-xl font-medium opacity-95 flex items-center justify-center gap-2">
                                    <Star className="text-yellow-300 fill-current" size={24}/> 期末學習成果總結 <Star className="text-yellow-300 fill-current" size={24}/>
                                </h2>
                            </div>
                            <div className="p-10">
                                <div className="space-y-6 text-gray-600">
                                    <p className="text-lg leading-relaxed text-center font-medium">嗨！各位同學好 👋 <br/>這個小測驗是回顧這學期<span className="text-rose-500 font-bold">「資料數位化」</span>的學習內容。</p>
                                    <div className="bg-yellow-50 p-6 rounded-3xl border-2 border-yellow-200 space-y-3 relative">
                                        <div className="absolute -top-3 left-6 bg-yellow-400 text-white px-3 py-1 rounded-full text-sm font-bold shadow-sm">評量說明</div>
                                        <ul className="list-none space-y-3 text-sm text-gray-600 mt-2">
                                            <li className="flex items-center gap-2"><Heart size={16} className="text-rose-400 fill-current" /> 題型只有「是非題」或「二選一」，輕鬆作答！</li>
                                            <li className="flex items-center gap-2"><Cloud size={16} className="text-sky-400 fill-current" /> <span className="text-rose-500 font-bold">不列入成績計算，而是為了了解你是否有學到課程中的觀念</span></li>
                                            <li className="flex items-center gap-2"><Lock size={16} className="text-purple-400 fill-current" /> 只能填寫一次，請勿重新整理頁面。</li>
                                        </ul>
                                    </div>
                                    <button onClick={() => setCurrentStep('quiz')} className="w-full bg-sky-400 hover:bg-sky-500 text-white font-bold py-4 px-6 rounded-full transition-all transform hover:scale-[1.03] active:scale-95 flex items-center justify-center gap-2 shadow-lg hover:shadow-sky-200 text-lg">開始 <ArrowRight size={24} /></button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (currentStep === 'quiz') {
                const currentConcept = QUIZ_DATA[currentConceptIndex];
                const currentQuestion = questionSequence[currentQuestionIdx];
                if (!currentConcept || !currentQuestion) return <div className="min-h-screen flex items-center justify-center bg-pink-50">載入中...</div>;
                const totalConcepts = QUIZ_DATA.length;
                const progress = ((currentConceptIndex) / totalConcepts) * 100;
                return (
                    <div className="min-h-screen bg-[#fff8f0] flex items-center justify-center p-4 font-sans">
                        <div className="max-w-xl w-full">
                            <div className="mb-6 bg-white p-3 rounded-full shadow-sm border border-orange-100 flex items-center gap-3">
                                <div className="flex-1 h-3 bg-gray-100 rounded-full overflow-hidden"><div className="h-full bg-gradient-to-r from-rose-300 to-orange-300 transition-all duration-700 ease-out" style={{ width: `${progress}%` }}></div></div>
                                <span className="text-xs font-bold text-orange-400 whitespace-nowrap">{Math.round(progress)}% 完成</span>
                            </div>
                            <div className="bg-white rounded-[2rem] shadow-xl border-4 border-white overflow-hidden relative ring-4 ring-orange-50">
                                <div className="bg-amber-100 px-8 py-5 flex items-center gap-3 border-b-2 border-amber-200 border-dashed">
                                    <div className="bg-white p-2 rounded-full text-amber-500 shadow-sm"><BookOpen size={20} /></div>
                                    <span className="font-bold text-amber-800 text-lg">{currentConcept.title}</span>
                                </div>
                                <div className="p-8">
                                    <div className="mb-6">
                                        <span className={`inline-block px-4 py-1.5 rounded-full text-sm font-bold mb-4 shadow-sm ${currentQuestion.type === 'TF' ? 'bg-emerald-100 text-emerald-600' : 'bg-sky-100 text-sky-600'}`}>{currentQuestion.type === 'TF' ? '⭕ ❌ 是非題' : '🔢 選擇題'}</span>
                                        <h3 className="text-xl font-bold text-gray-700 leading-relaxed tracking-wide">{currentQuestion.text}</h3>
                                    </div>
                                    <div className="grid grid-cols-1 gap-4">
                                        {currentQuestion.options.map((option, idx) => (
                                            <button key={idx} onClick={() => handleAnswer(option)} className="group option-btn relative p-5 text-left bg-gray-50 border-2 border-gray-100 rounded-2xl hover:border-sky-300 hover:bg-sky-50 transition-all duration-300 shadow-sm hover:shadow-md">
                                                <div className="flex items-center justify-between">
                                                    <span className="font-bold text-gray-600 group-hover:text-sky-600 text-lg pl-2">{option}</span>
                                                    <div className="w-8 h-8 rounded-full bg-white border-2 border-gray-200 group-hover:border-sky-400 flex items-center justify-center transition-colors"><div className="w-3 h-3 rounded-full bg-sky-400 opacity-0 group-hover:opacity-100 transition-opacity transform scale-0 group-hover:scale-100"></div></div>
                                                </div>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (currentStep === 'survey') {
                return (
                    <div className="min-h-screen bg-gradient-to-t from-teal-50 to-white flex items-center justify-center p-4 font-sans">
                        <div className="max-w-2xl w-full bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border-4 border-white">
                            <div className="bg-teal-400 p-8 text-white text-center">
                                <h2 className="text-2xl font-bold flex justify-center items-center gap-2"><Smile className="text-yellow-200" /> 學習態度自我檢核</h2>
                                <p className="opacity-90 mt-2 text-sm font-medium">回答這三題，就完成囉！</p>
                            </div>
                            <div className="p-8 space-y-8">
                                {SURVEY_QUESTIONS.map((q) => (
                                    <div key={q.id} className="bg-gray-50 p-6 rounded-3xl border border-gray-100">
                                        <h3 className="text-lg font-bold text-gray-700 mb-4 flex items-center gap-3"><div className="bg-white p-2 rounded-full text-teal-500 shadow-sm">{q.icon}</div>{q.text}</h3>
                                        <div className="grid grid-cols-2 gap-3">
                                            {q.options.map((opt) => (
                                                <button key={opt} onClick={() => handleSurveyAnswer(q.id, opt)} className={`py-3 px-4 rounded-xl text-sm font-bold transition-all ${surveyAnswers[q.id] === opt ? 'bg-teal-500 text-white shadow-lg scale-105' : 'bg-white text-gray-500 border border-gray-200 hover:border-teal-300 hover:text-teal-600'}`}>{opt}</button>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                                <button onClick={finishSurvey} className="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-4 px-6 rounded-2xl shadow-lg transition-transform hover:-translate-y-1 text-lg flex items-center justify-center gap-2">完成並送出 <ArrowRight /></button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (currentStep === 'submission') {
                return (
                    <div className="min-h-screen bg-gradient-to-t from-violet-100 to-white flex items-center justify-center p-4 font-sans">
                        <div className="max-w-md w-full bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border-4 border-white">
                            <div className="bg-violet-400 p-8 text-white text-center">
                                <h2 className="text-2xl font-bold flex justify-center items-center gap-2"><Award className="text-yellow-300" /> 恭喜完成！</h2>
                                <p className="opacity-90 mt-2 text-sm font-medium">填寫班級座號，查看你的成果卡 ✨</p>
                            </div>
                            <div className="p-8">
                                <form onSubmit={handleSubmit} className="space-y-5">
                                    <div>
                                        <label className="block text-sm font-bold text-gray-500 mb-2 ml-2">班級 (九年級)</label>
                                        <div className="relative">
                                            <select value={userInfo.className} onChange={(e) => setUserInfo({...userInfo, className: e.target.value})} className="w-full p-4 bg-gray-50 border-2 border-gray-100 rounded-2xl appearance-none focus:ring-4 focus:ring-violet-100 focus:border-violet-300 outline-none text-lg text-gray-700 transition-all font-medium">
                                                {[...Array(10)].map((_, i) => <option key={i+1} value={String(i+1)}>{i+1} 班</option>)}
                                            </select>
                                            <div className="absolute right-4 top-1/2 transform -translate-y-1/2 pointer-events-none text-gray-400">▼</div>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-500 mb-2 ml-2">座號</label>
                                        <input type="number" min="1" max="50" placeholder="請輸入號碼..." value={userInfo.seatNumber} onChange={(e) => setUserInfo({...userInfo, seatNumber: e.target.value})} className="w-full p-4 bg-gray-50 border-2 border-gray-100 rounded-2xl focus:ring-4 focus:ring-violet-100 focus:border-violet-300 outline-none text-lg text-gray-700 transition-all font-medium placeholder-gray-300" required />
                                    </div>
                                    {submitError && <div className="p-4 bg-rose-50 text-rose-500 rounded-2xl text-sm flex items-center gap-2 border border-rose-100"><AlertCircle size={18}/> {submitError}</div>}
                                    {!GOOGLE_SCRIPT_URL && <div className="p-3 bg-amber-50 text-amber-600 rounded-xl text-xs text-center border border-amber-100">⚠️ 模擬模式：資料不會實際上傳</div>}
                                    <button type="submit" disabled={isSubmitting} className={`w-full py-4 px-6 rounded-2xl font-bold text-white shadow-lg flex items-center justify-center gap-2 transition-all mt-4 ${isSubmitting ? 'bg-gray-300 cursor-not-allowed' : 'bg-violet-400 hover:bg-violet-500 hover:shadow-violet-200 hover:-translate-y-1'}`}>
                                        {isSubmitting ? '傳送中...' : '送出並查看結果'} {!isSubmitting && <Send size={18} />}
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                );
            }

            if (currentStep === 'result') {
                const displayFeedback = (storedFeedback && storedFeedback.length > 0) ? storedFeedback : generateFeedbackData();

                return (
                    <div className="min-h-screen bg-[#f8fafc] p-4 font-sans relative">
                        {showDuplicateModal && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
                                <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-sm w-full text-center border-4 border-yellow-200" style={{animation: 'slideIn 0.4s ease-out'}}>
                                    <div className="inline-flex items-center justify-center w-16 h-16 bg-yellow-100 text-yellow-600 rounded-full mb-4"><Info size={32} /></div>
                                    <h3 className="text-xl font-bold text-gray-800 mb-2">溫馨提醒</h3>
                                    <p className="text-gray-600 mb-6 font-medium">您已經完成過評量囉！<br/>請將結果截圖上傳即可，<br/><span className="text-rose-500 font-bold">不需重複作答</span>。</p>
                                    <button onClick={() => setShowDuplicateModal(false)} className="w-full bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-3 px-6 rounded-xl transition-transform hover:scale-105 shadow-md flex items-center justify-center gap-2">我知道了 <CheckCircle size={18} /></button>
                                </div>
                            </div>
                        )}
                        <div className="max-w-3xl mx-auto space-y-6">
                            <div className="bg-white rounded-[2rem] shadow-xl overflow-hidden border-4 border-white relative">
                                {alreadyCompleted && <div className="bg-amber-100 text-amber-700 text-center py-2 text-sm font-bold flex items-center justify-center gap-2"><Lock size={14}/> 您已完成測驗</div>}
                                <div className="p-10 text-center bg-gradient-to-b from-green-50 to-white">
                                    <div className="inline-flex items-center justify-center w-20 h-20 bg-green-100 text-green-500 rounded-full mb-5 shadow-sm"><CheckCircle size={40} /></div>
                                    <h2 className="text-3xl font-extrabold text-gray-700 mb-2 tracking-tight">{userInfo.className ? `九年 ${userInfo.className} 班 ${userInfo.seatNumber} 號` : '測驗完成'}</h2>
                                    <p className="text-gray-400 text-sm font-medium">做得好！以下是你的學習分析</p>
                                    <div className="flex flex-col items-center justify-center mt-6 p-6 bg-white rounded-3xl w-full max-w-xs mx-auto border-2 border-dashed border-gray-200 shadow-inner">
                                        <span className="text-gray-400 text-xs uppercase tracking-widest font-bold mb-1">您的專屬識別碼</span>
                                        <span className="text-4xl font-mono font-bold text-sky-500 tracking-widest">{randomId}</span>
                                        <span className="text-xs text-rose-400 mt-2 font-medium bg-rose-50 px-3 py-1 rounded-full">請截圖整個大框框的範圍</span>
                                    </div>
                                </div>
                            </div>
                            {displayFeedback.map((item, index) => (
                                <div key={index} className={`bg-white rounded-[2rem] shadow-sm p-8 border-4 transition-transform hover:scale-[1.01] duration-300 ${item.level === 'A' ? 'border-emerald-100' : item.level === 'B' ? 'border-sky-100' : 'border-orange-50'}`}>
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className={`text-xl font-bold flex items-center gap-2 ${item.level === 'A' ? 'text-emerald-600' : item.level === 'B' ? 'text-sky-600' : 'text-orange-400'}`}>{item.level === 'A' && <Star className="fill-current" size={20}/>} {item.title}</h3>
                                        {!isDuplicate && item.level && item.level !== 'C' && <span className={`px-4 py-1.5 rounded-full text-sm font-bold shadow-sm ${item.level === 'A' ? 'bg-emerald-100 text-emerald-600' : 'bg-sky-100 text-sky-600'}`}>表現等級：{item.level}</span>}
                                    </div>
                                    <p className="text-gray-600 leading-relaxed text-justify whitespace-pre-wrap font-medium">{item.text}</p>
                                </div>
                            ))}
                            <div className="bg-gradient-to-r from-violet-300 to-fuchsia-300 rounded-[2rem] shadow-lg p-8 text-white relative overflow-hidden">
                                <div className="absolute top-0 right-0 w-40 h-40 bg-white/10 rounded-full translate-x-10 -translate-y-10 blur-xl"></div>
                                <h3 className="text-xl font-bold mb-4 flex items-center gap-2 relative z-10"><Award size={24} className="text-yellow-200" /> 老師的話</h3>
                                <p className="leading-relaxed font-medium relative z-10 text-white/95">在九年級這個階段，我們希望你學到的不只是「算對數學題」，而是能連結真實世界。<br/>希望你現在已經懂得為什麼 3 分鐘的未壓縮錄音檔會這麼大，以及為什麼我們需要 MP3 格式來壓縮它。期待這門課能幫助你了解生活中的數位科技，其實都源自於這些 0 與 1 的基礎原理！</p>
                            </div>
                            <div className="text-center text-gray-400 text-xs py-6 font-medium">評量結束，請依上方說明進行截圖上傳</div>
                        </div>
                    </div>
                );
            }

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AssessmentApp />);
    </script>
</body>
</html>