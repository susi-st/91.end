import React, { useState, useEffect } from 'react';
import { CheckCircle, AlertCircle, ArrowRight, BookOpen, Calculator, Layout, Award, RefreshCw, Send, Lock, Star, Heart, Cloud } from 'lucide-react';

// !!! é‡è¦ï¼šè«‹å°‡ Google Apps Script éƒ¨ç½²å¾Œçš„ Web App URL è²¼åœ¨é€™è£¡ !!!
// è‹¥æœªè¨­å®šï¼Œè³‡æ–™å°‡ç„¡æ³•å¯«å…¥è©¦ç®—è¡¨ï¼Œä½†ä»å¯çœ‹åˆ°æ¨¡æ“¬çµæœã€‚
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzpZuCMZXJMAeu5EgcWCQROj8k-b7FMXDRTqlxZRI65sTtJJmGJ4dcGj7lq74iuxni9/exec"; 

// --- è³‡æ–™è¨­å®š (é¡Œç›®èˆ‡è©•èªåº«) ---

const DIMENSIONS = {
  CONCEPT: 'concept',
  COMPUTATION: 'computation',
  APPLICATION: 'application'
};

const FEEDBACK_LIBRARY = {
  [DIMENSIONS.CONCEPT]: {
    A: "ä½ åœ¨è³‡è¨Šç§‘æŠ€çš„é‚è¼¯ç†è§£ä¸Šè¡¨ç¾å“è¶Šï¼ä¸åƒ…èƒ½ç²¾ç¢ºæŒæ¡è³‡æ–™æ•¸ä½åŒ–ï¼ˆå–æ¨£èˆ‡é‡åŒ–ï¼‰çš„æ ¸å¿ƒåŸç†ï¼Œä¹Ÿèƒ½æ¸…æ¥šå€åˆ†é»é™£èˆ‡å‘é‡åœ–çš„å·®ç•°ã€‚",
    B: "æœ¬å­¸æœŸä½ å°é›»è…¦é‹ä½œåŸç†å·²æœ‰ç©©å›ºçš„åŸºç¤ï¼Œèƒ½ç†è§£ç¾å¯¦ä¸–ç•Œçš„è²éŸ³èˆ‡å½±åƒå¦‚ä½•è½‰æ›ç‚ºé›»è…¦ä¸­çš„ 0 èˆ‡ 1ï¼Œä½†åœ¨ç´°ç¯€åŸç†çš„è§£é‡‹ä¸Šå¯ä»¥æ›´ç²¾ç¢ºã€‚",
    C: "ä½ å·²ç¶“å»ºç«‹äº†é›»è…¦ä½¿ç”¨ 0 èˆ‡ 1 å„²å­˜è³‡æ–™çš„åŸºæœ¬æ¦‚å¿µã€‚å»ºè­°åœ¨æ•¸ä½åŒ–åŸç†ï¼ˆå¦‚è²éŸ³çš„å–æ¨£éç¨‹ï¼‰å¤šèŠ±é»æ™‚é–“è¤‡ç¿’ï¼Œé‡æ¸…å–æ¨£èˆ‡é‡åŒ–çš„å·®ç•°ã€‚"
  },
  [DIMENSIONS.COMPUTATION]: {
    A: "åœ¨äºŒé€²ä½é‹ç®—èˆ‡æª”æ¡ˆå®¹é‡ä¼°ç®—ä¸Šå±•ç¾äº†åš´è¬¹çš„é‹ç®—æ€ç¶­ï¼Œèƒ½éˆæ´»é‹ç”¨å…¬å¼è¨ˆç®—æœªå£“ç¸®éŸ³è¨Šå¤§å°ï¼Œä¸¦æ­£ç¢ºé€²è¡Œå–®ä½çš„æ›ç®—ã€‚",
    B: "åœ¨é€²ä½åˆ¶è½‰æ›è¨ˆç®—ä¸Šå¤§è‡´æ­£ç¢ºï¼Œå”¯åœ¨è¤‡é›œçš„å–®ä½æ›ç®—ï¼ˆå¦‚ bits è½‰ MBï¼‰ç´°ç¯€ä¸Šå¯å†ç´°å¿ƒä¸€é»ï¼Œå…¬å¼é‹ç”¨å°šç¨±ç†Ÿç·´ã€‚",
    C: "å»ºè­°å¤šç·´ç¿’äºŒé€²ä½çš„è¨ˆç®—è¦å‰‡ï¼Œä¸¦è©¦è‘—ææ‡‚ Bit èˆ‡ Byte çš„å€æ•¸å·®ç•°ï¼Œé€™å°æ–¼æœªä¾†è©•ä¼°æ‰‹æ©Ÿæˆ–é›»è…¦å®¹é‡éå¸¸é‡è¦ã€‚"
  },
  [DIMENSIONS.APPLICATION]: {
    A: "ä½ å°æ–¼ä¸åŒæ–‡å­—ç·¨ç¢¼ï¼ˆUnicode/Big-5ï¼‰èˆ‡å½±åƒæ ¼å¼çš„ç‰¹æ€§ç­è‹¥æŒ‡æŒï¼Œèƒ½é‡å°ä¸åŒéœ€æ±‚åšå‡ºæœ€ä½³çš„æŠ€è¡“é¸æ“‡ï¼Œå…·å‚™å„ªç§€çš„æ•¸ä½å…¬æ°‘ç´ é¤Šã€‚",
    B: "å°æ–¼å¸¸è¦‹çš„æª”æ¡ˆæ ¼å¼ï¼ˆJPG, MP3ï¼‰æœ‰åŸºæœ¬èªè­˜ï¼Œè‹¥èƒ½é€²ä¸€æ­¥æ·±ç©¶ä¸åŒç·¨ç¢¼ç³»çµ±ï¼ˆå¦‚äº‚ç¢¼åŸå› ï¼‰çš„å·®ç•°ï¼Œä½ çš„è³‡è¨Šç´ é¤Šå°‡æ›´ä¸Šä¸€å±¤æ¨“ã€‚",
    C: "å°æ–¼æª”æ¡ˆæ ¼å¼çš„ç”¨é€”èˆ‡æ–‡å­—ç·¨ç¢¼çš„æ¦‚å¿µè¼ƒç‚ºæ¨¡ç³Šï¼Œå»ºè­°å¤šè§€å¯Ÿç”Ÿæ´»ä¸­çš„æª”æ¡ˆé™„æª”åï¼Œå°‡æœ‰åŠ©æ–¼ç†è§£é€™äº›æ•¸ä½å·¥å…·çš„ç‰¹æ€§ã€‚"
  }
};

const QUIZ_DATA = [
  {
    id: 'c1',
    title: 'æ•¸ä½åŒ–åŸç†ï¼šå–æ¨£èˆ‡é‡åŒ–',
    dimension: DIMENSIONS.CONCEPT,
    questions: [
      { id: 'q1-1', type: 'TF', text: 'ã€Œå–æ¨£ã€æ˜¯æŒ‡å°‡é€£çºŒçš„é¡æ¯”è¨Šè™Ÿï¼Œåœ¨æ™‚é–“è»¸ä¸Šåˆ‡å‰²æˆä¸é€£çºŒçš„é»ã€‚', options: ['æ­£ç¢º', 'éŒ¯èª¤'], correctAnswer: 'æ­£ç¢º' },
      { id: 'q1-2', type: 'MC', text: 'è‹¥è¦æé«˜éŒ„éŸ³çš„å“è³ªï¼Œä½¿å…¶æ›´æ¥è¿‘åŸéŸ³ï¼Œæ‡‰è©²å¦‚ä½•èª¿æ•´ï¼Ÿ', options: ['æé«˜å–æ¨£é »ç‡èˆ‡è§£æåº¦', 'é™ä½å–æ¨£é »ç‡èˆ‡è§£æåº¦'], correctAnswer: 'æé«˜å–æ¨£é »ç‡èˆ‡è§£æåº¦' },
      { id: 'q1-3', type: 'MC', text: 'é—œæ–¼ã€Œé‡åŒ–ã€çš„æ•˜è¿°ï¼Œä¸‹åˆ—ä½•è€…æ­£ç¢ºï¼Ÿ', options: ['é‡åŒ–æ˜¯ç´€éŒ„æ³¢å½¢çš„æŒ¯å¹…æ•¸å€¼', 'é‡åŒ–æ˜¯ç´€éŒ„æ™‚é–“çš„é•·çŸ­'], correctAnswer: 'é‡åŒ–æ˜¯ç´€éŒ„æ³¢å½¢çš„æŒ¯å¹…æ•¸å€¼' }
    ]
  },
  {
    id: 'c2',
    title: 'æ•¸ä½å½±åƒï¼šé»é™£èˆ‡å‘é‡',
    dimension: DIMENSIONS.CONCEPT,
    questions: [
      { id: 'q2-1', type: 'TF', text: 'ã€Œå‘é‡åœ–ã€æ”¾å¤§å¾Œé‚Šç·£æœƒç”¢ç”Ÿé‹¸é½’ç‹€çš„å¤±çœŸï¼Œä¸é©åˆç”¨æ–¼å¤§åœ–è¼¸å‡ºã€‚', options: ['æ­£ç¢º', 'éŒ¯èª¤'], correctAnswer: 'éŒ¯èª¤' },
      { id: 'q2-2', type: 'MC', text: 'æ‰‹æ©Ÿæ‹å‡ºä¾†çš„ç…§ç‰‡ï¼Œé€šå¸¸æ˜¯å±¬æ–¼å“ªä¸€ç¨®é¡å‹çš„åœ–æª”ï¼Ÿ', options: ['é»é™£åœ– (Bitmap)', 'å‘é‡åœ– (Vector)'], correctAnswer: 'é»é™£åœ– (Bitmap)' },
      { id: 'q2-3', type: 'MC', text: 'å“ªä¸€ç¨®åœ–æª”æ˜¯é€éæ•¸å­¸å…¬å¼ä¾†ç´€éŒ„åœ–å½¢çš„å½¢ç‹€èˆ‡é¡è‰²ï¼Ÿ', options: ['å‘é‡åœ–', 'é»é™£åœ–'], correctAnswer: 'å‘é‡åœ–' }
    ]
  },
  {
    id: 'c3',
    title: 'è³‡æ–™è¡¨ç¤ºï¼šäºŒé€²ä½ç³»çµ±',
    dimension: DIMENSIONS.COMPUTATION,
    questions: [
      { id: 'q3-1', type: 'TF', text: 'é›»è…¦å…§éƒ¨è™•ç†è³‡æ–™æ™‚ï¼Œä¸»è¦æ˜¯ä½¿ç”¨ã€Œåé€²ä½ã€ç³»çµ±ã€‚', options: ['æ­£ç¢º', 'éŒ¯èª¤'], correctAnswer: 'éŒ¯èª¤' },
      { id: 'q3-2', type: 'MC', text: 'åé€²ä½çš„æ•¸å­—ã€Œ3ã€ï¼Œè½‰æ›æˆäºŒé€²ä½æ˜¯å¤šå°‘ï¼Ÿ', options: ['10', '11'], correctAnswer: '11' },
      { id: 'q3-3', type: 'MC', text: 'äºŒé€²ä½çš„ã€Œ100ã€ï¼Œè½‰æ›æˆåé€²ä½æ˜¯å¤šå°‘ï¼Ÿ', options: ['4', '8'], correctAnswer: '4' }
    ]
  },
  {
    id: 'c4',
    title: 'å„²å­˜å–®ä½èˆ‡å®¹é‡è¨ˆç®—',
    dimension: DIMENSIONS.COMPUTATION,
    questions: [
      { id: 'q4-1', type: 'MC', text: '1 Byte (ä½å…ƒçµ„) ç­‰æ–¼å¤šå°‘ bits (ä½å…ƒ)ï¼Ÿ', options: ['8 bits', '10 bits'], correctAnswer: '8 bits' },
      { id: 'q4-2', type: 'TF', text: 'åœ¨å„²å­˜å–®ä½ä¸­ï¼Œ1 GB çš„å®¹é‡æ¯” 1 MB é‚„è¦å°ã€‚', options: ['æ­£ç¢º', 'éŒ¯èª¤'], correctAnswer: 'éŒ¯èª¤' },
      { id: 'q4-3', type: 'MC', text: 'è‹¥è¦è¨ˆç®—æœªå£“ç¸®è²éŸ³æª”çš„å¤§å°ï¼Œå…¬å¼ä¸­ã€Œä¸éœ€è¦ã€åŒ…å«ä¸‹åˆ—å“ªä¸€é …ï¼Ÿ', options: ['éŒ„éŸ³æ™‚é–“é•·åº¦', 'éº¥å…‹é¢¨çš„å» ç‰Œ'], correctAnswer: 'éº¥å…‹é¢¨çš„å» ç‰Œ' }
    ]
  },
  {
    id: 'c5',
    title: 'ç³»çµ±æ‡‰ç”¨ï¼šç·¨ç¢¼èˆ‡æ ¼å¼',
    dimension: DIMENSIONS.APPLICATION,
    questions: [
      { id: 'q5-1', type: 'MC', text: 'è‹¥ç¶²é å‡ºç¾äº‚ç¢¼ï¼Œé€šå¸¸æ˜¯å› ç‚ºå“ªå…©ç¨®ç·¨ç¢¼ç³»çµ±è¡çªï¼Ÿ', options: ['Big-5 èˆ‡ Unicode', 'RGB èˆ‡ CMYK'], correctAnswer: 'Big-5 èˆ‡ Unicode' },
      { id: 'q5-2', type: 'MC', text: 'æƒ³è¦è£½ä½œèƒŒæ™¯é€æ˜çš„åœ–ç¤ºï¼Œæ‡‰è©²é¸æ“‡å“ªç¨®æª”æ¡ˆæ ¼å¼ï¼Ÿ', options: ['JPG', 'PNG'], correctAnswer: 'PNG' },
      { id: 'q5-3', type: 'MC', text: 'RGB è‰²å½©æ¨¡å¼ä¸­ï¼Œ(255, 255, 255) ä»£è¡¨ä»€éº¼é¡è‰²ï¼Ÿ', options: ['é»‘è‰²', 'ç™½è‰²'], correctAnswer: 'ç™½è‰²' }
    ]
  }
];

// --- è¼”åŠ©å‡½å¼ ---

// ç”¢ç”Ÿ 5 ä½æ•¸éš¨æ©Ÿç¢¼
const generateRandomId = () => Math.floor(10000 + Math.random() * 90000).toString();

// æ ¼å¼åŒ–æ™‚é–“ (ç§’ -> mmåˆ†ssç§’)
const formatTime = (seconds) => {
  const m = Math.floor(seconds / 60);
  const s = Math.floor(seconds % 60);
  return `${m}åˆ†${s}ç§’`;
};

// LocalStorage Key
const STORAGE_KEY = 'ninth_grade_assessment_v2';

export default function AssessmentApp() {
  const [currentStep, setCurrentStep] = useState('loading'); // loading, intro, quiz, submission, result
  const [currentConceptIndex, setCurrentConceptIndex] = useState(0);
  const [questionSequence, setQuestionSequence] = useState([]); 
  const [currentQuestionIdx, setCurrentQuestionIdx] = useState(0);
  const [answers, setAnswers] = useState({});
  const [scores, setScores] = useState({});
  
  // æ–°å¢ç‹€æ…‹
  const [startTime, setStartTime] = useState(null);
  const [endTime, setEndTime] = useState(null);
  const [userInfo, setUserInfo] = useState({ className: '1', seatNumber: '' });
  const [randomId, setRandomId] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitError, setSubmitError] = useState('');
  const [alreadyCompleted, setAlreadyCompleted] = useState(false);
  const [storedFeedback, setStoredFeedback] = useState([]); // ç”¨æ–¼é‡æ•´å¾Œé¡¯ç¤º

  // 1. åˆå§‹åŒ–æª¢æŸ¥ (Component Mount)
  useEffect(() => {
    const savedData = localStorage.getItem(STORAGE_KEY);
    if (savedData) {
      const parsedData = JSON.parse(savedData);
      if (parsedData.completed) {
        // å¦‚æœå·²ç¶“å®Œæˆï¼Œç›´æ¥æ¢å¾©è³‡æ–™ä¸¦è·³è½‰åˆ°çµæœé 
        setRandomId(parsedData.randomId);
        setUserInfo(parsedData.userInfo);
        setStoredFeedback(parsedData.feedbackList); // éœ€è¦å„²å­˜è©•èªä»¥ä¾¿æ¢å¾©
        setAlreadyCompleted(true);
        setCurrentStep('result');
        return;
      }
    }
    setCurrentStep('intro');
  }, []);

  // 2. æ¸¬é©—é‚è¼¯
  useEffect(() => {
    if (currentStep === 'quiz' && currentConceptIndex === 0 && currentQuestionIdx === 0 && !startTime) {
      setStartTime(Date.now());
    }
    if (currentStep === 'quiz') {
      loadConcept(currentConceptIndex || 0);
    }
  }, [currentStep]);

  const loadConcept = (index) => {
    if (index >= QUIZ_DATA.length) {
      setEndTime(Date.now());
      setCurrentStep('submission');
      return;
    }
    setCurrentConceptIndex(index);
    const concept = QUIZ_DATA[index];
    // è‹¥å°šæœªè¨­å®šéè©² Concept çš„é¡Œç›®åºåˆ—ï¼Œå‰‡åˆå§‹åŒ–
    if (questionSequence.length === 0 || QUIZ_DATA[index].id !== QUIZ_DATA[currentConceptIndex]?.id) {
       setQuestionSequence([concept.questions[0], concept.questions[1]]);
       setCurrentQuestionIdx(0);
    }
  };

  const handleAnswer = (option) => {
    const concept = QUIZ_DATA[currentConceptIndex];
    const currentQ = questionSequence[currentQuestionIdx];
    const isCorrect = option === currentQ.correctAnswer;
    
    const newAnswers = { ...answers, [currentQ.id]: isCorrect };
    setAnswers(newAnswers);

    if (currentQuestionIdx === 1) { 
      const q1Result = newAnswers[concept.questions[0].id];
      const q2Result = isCorrect;
      let nextSequence = [...questionSequence];
      
      if (q1Result !== q2Result) {
        nextSequence.push(concept.questions[2]); 
        setQuestionSequence(nextSequence);
        setCurrentQuestionIdx(currentQuestionIdx + 1);
      } else {
        goToNextConcept(concept.id, newAnswers, nextSequence);
      }
    } else if (currentQuestionIdx === 2) { 
      goToNextConcept(concept.id, newAnswers, questionSequence);
    } else {
      setCurrentQuestionIdx(currentQuestionIdx + 1);
    }
  };

  const goToNextConcept = (conceptId, currentAnswers, sequence) => {
    let correctCount = 0;
    sequence.forEach(q => {
      if (currentAnswers[q.id]) correctCount++;
    });

    setScores(prev => ({
      ...prev,
      [conceptId]: { correct: correctCount, total: sequence.length }
    }));

    // é‡ç½®åºåˆ—ç‹€æ…‹ä»¥è¿æ¥ä¸‹ä¸€é¡Œ
    setQuestionSequence([]); 
    setCurrentQuestionIdx(0);
    
    // ç§»å‹•åˆ°ä¸‹ä¸€å€‹ç´¢å¼•
    loadConcept(currentConceptIndex + 1);
  };

  // 3. è©•èªç”Ÿæˆé‚è¼¯
  const generateFeedbackData = () => {
    let dimensionScores = {
      [DIMENSIONS.CONCEPT]: { correct: 0, total: 0 },
      [DIMENSIONS.COMPUTATION]: { correct: 0, total: 0 },
      [DIMENSIONS.APPLICATION]: { correct: 0, total: 0 }
    };

    QUIZ_DATA.forEach(concept => {
      const score = scores[concept.id];
      if (score) {
        dimensionScores[concept.dimension].correct += score.correct;
        dimensionScores[concept.dimension].total += score.total;
      }
    });

    const feedbackList = Object.values(DIMENSIONS).map(dim => {
      const { correct, total } = dimensionScores[dim] || { correct: 0, total: 0 };
      const percentage = total === 0 ? 0 : (correct / total);
      let level = 'C';
      if (percentage >= 0.8) level = 'A';
      else if (percentage >= 0.5) level = 'B';
      
      let title = "";
      if(dim === DIMENSIONS.CONCEPT) title = "ä¸€ã€æ•¸ä½åŒ–åŸç†çš„ç†è§£";
      if(dim === DIMENSIONS.COMPUTATION) title = "äºŒã€é‹ç®—æ€ç¶­èˆ‡æ•¸å€¼è½‰æ›";
      if(dim === DIMENSIONS.APPLICATION) title = "ä¸‰ã€ç³»çµ±æ‡‰ç”¨èˆ‡ç·¨ç¢¼ç´ é¤Š";

      return {
        dim,
        title,
        level,
        text: FEEDBACK_LIBRARY[dim][level]
      };
    });

    return feedbackList;
  };

  // 4. è³‡æ–™é€å‡ºé‚è¼¯
  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!userInfo.seatNumber) {
      alert("è«‹è¼¸å…¥åº§è™Ÿï¼");
      return;
    }

    setIsSubmitting(true);
    setSubmitError('');

    // æº–å‚™è³‡æ–™
    const feedbackList = generateFeedbackData();
    const generatedRandomId = generateRandomId();
    const durationSeconds = (endTime - startTime) / 1000;
    const formattedTime = formatTime(durationSeconds);
    const teacherSummaryText = "åœ¨ä¹å¹´ç´šé€™å€‹éšæ®µï¼Œè©•é‡çš„æ ¸å¿ƒä¸æ‡‰åªæ˜¯ã€Œç®—å°æ•¸å­¸é¡Œã€ï¼Œè€Œæ˜¯ã€Œé€£çµçœŸå¯¦ä¸–ç•Œã€ã€‚å¸Œæœ›ä½ ç¾åœ¨å·²ç¶“æ‡‚å¾—ç‚ºä»€éº¼ 3 åˆ†é˜çš„æœªå£“ç¸®éŒ„éŸ³æª”æœƒé€™éº¼å¤§ï¼Œä»¥åŠç‚ºä»€éº¼æˆ‘å€‘éœ€è¦ MP3 æ ¼å¼ä¾†å£“ç¸®å®ƒã€‚";

    // çµ„åˆè¦å‚³é€çµ¦ Google Sheet çš„è³‡æ–™
    const payload = {
      className: `ä¹å¹´${userInfo.className}ç­`,
      seatNumber: userInfo.seatNumber,
      conceptLevel: feedbackList.find(f => f.dim === DIMENSIONS.CONCEPT)?.level,
      computationLevel: feedbackList.find(f => f.dim === DIMENSIONS.COMPUTATION)?.level,
      applicationLevel: feedbackList.find(f => f.dim === DIMENSIONS.APPLICATION)?.level,
      feedbackText: feedbackList.map(f => `[${f.title}] ${f.text}`).join("\n"),
      teacherSummary: teacherSummaryText,
      totalTime: formattedTime,
      randomId: generatedRandomId
    };

    try {
      if (GOOGLE_SCRIPT_URL) {
        // ç™¼é€ POST è«‹æ±‚ (no-cors æ¨¡å¼ç„¡æ³•è®€å–å›å‚³å€¼ï¼Œä½†å¯æˆåŠŸå¯«å…¥)
        await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors', 
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });
      } else {
        console.warn("æœªè¨­å®š GOOGLE_SCRIPT_URLï¼Œåƒ…æ¨¡æ“¬é€å‡ºã€‚");
        // æ¨¡æ“¬å»¶é²
        await new Promise(resolve => setTimeout(resolve, 1500));
      }

      // æˆåŠŸå¾Œè™•ç†
      setRandomId(generatedRandomId);
      setStoredFeedback(feedbackList);
      
      // å¯«å…¥ LocalStorage é˜²æ­¢é‡è¦†æäº¤
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        completed: true,
        randomId: generatedRandomId,
        userInfo: userInfo,
        feedbackList: feedbackList
      }));

      setCurrentStep('result');

    } catch (error) {
      console.error("Submission Error:", error);
      setSubmitError("è³‡æ–™å‚³é€å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚");
    } finally {
      setIsSubmitting(false);
    }
  };

  // --- Render ---

  if (currentStep === 'loading') {
    return <div className="min-h-screen flex items-center justify-center bg-pink-50 text-gray-500 font-medium">âœ¨ æº–å‚™ä¸­...</div>;
  }

  // 1. ä»‹ç´¹é  - é¦¬å¡é¾é¢¨æ ¼
  if (currentStep === 'intro') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-pink-100 via-purple-100 to-sky-100 flex items-center justify-center p-4 font-sans">
        <div className="bg-white/90 backdrop-blur max-w-2xl w-full rounded-[3rem] shadow-xl overflow-hidden border-4 border-white">
          <div className="bg-rose-400 p-10 text-white text-center relative overflow-hidden">
            {/* è£é£¾åœ“é» */}
            <div className="absolute top-0 left-0 w-20 h-20 bg-white/20 rounded-full -translate-x-10 -translate-y-10"></div>
            <div className="absolute bottom-0 right-0 w-32 h-32 bg-white/10 rounded-full translate-x-10 translate-y-10"></div>
            
            <h1 className="text-3xl font-bold mb-3 tracking-wide drop-shadow-md">ä¹å¹´ç´šè³‡è¨Šç§‘æŠ€</h1>
            <h2 className="text-xl font-medium opacity-95 flex items-center justify-center gap-2">
              <Star className="text-yellow-300 fill-current" size={24}/> æœŸæœ«å­¸ç¿’æˆæœç¸½çµ <Star className="text-yellow-300 fill-current" size={24}/>
            </h2>
          </div>
          <div className="p-10">
            <div className="space-y-6 text-gray-600">
              <p className="text-lg leading-relaxed text-center font-medium">
                å—¨ï¼å„ä½åŒå­¸å¥½ ğŸ‘‹ <br/>
                é€™æ˜¯ä¸€å€‹å¯æ„›çš„å°æ¸¬é©—ï¼Œå¹«ä½ å›é¡§é€™å­¸æœŸå­¸åˆ°çš„<br/>
                <span className="text-rose-500 font-bold">è³‡æ–™æ•¸ä½åŒ–</span> èˆ‡ <span className="text-sky-500 font-bold">0èˆ‡1çš„ç§˜å¯†</span>ã€‚
              </p>
              
              <div className="bg-yellow-50 p-6 rounded-3xl border-2 border-yellow-200 space-y-3 relative">
                 <div className="absolute -top-3 left-6 bg-yellow-400 text-white px-3 py-1 rounded-full text-sm font-bold shadow-sm">
                   æ¸¬é©—èªªæ˜
                 </div>
                <ul className="list-none space-y-3 text-sm text-gray-600 mt-2">
                  <li className="flex items-center gap-2">
                    <Heart size={16} className="text-rose-400 fill-current" /> é¡Œå‹åªæœ‰ã€Œæ˜¯éé¡Œã€æˆ–ã€ŒäºŒé¸ä¸€ã€ï¼Œè¼•é¬†ä½œç­”ï¼
                  </li>
                  <li className="flex items-center gap-2">
                    <Cloud size={16} className="text-sky-400 fill-current" /> æ¸¬é©—çµæŸå¾Œï¼Œæœƒç”¢ç”Ÿä¸€çµ„<strong>å°ˆå±¬è­˜åˆ¥ç¢¼</strong>ã€‚
                  </li>
                  <li className="flex items-center gap-2">
                    <Lock size={16} className="text-purple-400 fill-current" /> <span className="text-rose-500 font-bold">æ³¨æ„ï¼š</span>åªèƒ½å¡«å¯«ä¸€æ¬¡ï¼Œè«‹å‹¿é‡æ–°æ•´ç†é é¢å–”ï¼
                  </li>
                </ul>
              </div>

              <button 
                onClick={() => setCurrentStep('quiz')}
                className="w-full bg-sky-400 hover:bg-sky-500 text-white font-bold py-4 px-6 rounded-full transition-all transform hover:scale-[1.03] active:scale-95 flex items-center justify-center gap-2 shadow-lg hover:shadow-sky-200 text-lg"
              >
                é–‹å§‹å†’éšª <ArrowRight size={24} />
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // 2. æ¸¬é©—é  - é¦¬å¡é¾é¢¨æ ¼
  if (currentStep === 'quiz') {
    const currentConcept = QUIZ_DATA[currentConceptIndex];
    const currentQuestion = questionSequence[currentQuestionIdx];
    
    if (!currentConcept || !currentQuestion) {
      return <div className="min-h-screen flex items-center justify-center bg-pink-50 text-gray-400">è¼‰å…¥é¡Œç›®ä¸­...</div>;
    }
    
    const totalConcepts = QUIZ_DATA.length;
    const progress = ((currentConceptIndex) / totalConcepts) * 100;

    return (
      <div className="min-h-screen bg-[#fff8f0] flex items-center justify-center p-4 font-sans">
        <div className="max-w-xl w-full">
          {/* é€²åº¦æ¢ */}
          <div className="mb-6 bg-white p-3 rounded-full shadow-sm border border-orange-100 flex items-center gap-3">
            <div className="flex-1 h-3 bg-gray-100 rounded-full overflow-hidden">
               <div className="h-full bg-gradient-to-r from-rose-300 to-orange-300 transition-all duration-700 ease-out" style={{ width: `${progress}%` }}></div>
            </div>
            <span className="text-xs font-bold text-orange-400 whitespace-nowrap">{Math.round(progress)}% å®Œæˆ</span>
          </div>

          <div className="bg-white rounded-[2rem] shadow-xl border-4 border-white overflow-hidden relative ring-4 ring-orange-50">
            {/* æ¨™é¡Œåˆ— */}
            <div className="bg-amber-100 px-8 py-5 flex items-center gap-3 border-b-2 border-amber-200 border-dashed">
              <div className="bg-white p-2 rounded-full text-amber-500 shadow-sm">
                <BookOpen size={20} />
              </div>
              <span className="font-bold text-amber-800 text-lg">{currentConcept.title}</span>
            </div>

            <div className="p-8">
               {/* é¡Œç›®æ¨™ç±¤ */}
               <div className="mb-6">
                 <span className={`inline-block px-4 py-1.5 rounded-full text-sm font-bold mb-4 shadow-sm
                    ${currentQuestion.type === 'TF' ? 'bg-emerald-100 text-emerald-600' : 'bg-sky-100 text-sky-600'}`}>
                   {currentQuestion.type === 'TF' ? 'â­• âŒ æ˜¯éé¡Œ' : 'ğŸ”¢ é¸æ“‡é¡Œ'}
                 </span>
                 <h3 className="text-xl font-bold text-gray-700 leading-relaxed tracking-wide">
                   {currentQuestion.text}
                 </h3>
               </div>

               {/* é¸é … */}
               <div className="grid grid-cols-1 gap-4">
                 {currentQuestion.options.map((option, idx) => (
                   <button
                     key={idx}
                     onClick={() => handleAnswer(option)}
                     className="group relative p-5 text-left bg-gray-50 border-2 border-gray-100 rounded-2xl hover:border-sky-300 hover:bg-sky-50 transition-all duration-300 shadow-sm hover:shadow-md active:scale-[0.98]"
                   >
                     <div className="flex items-center justify-between">
                       <span className="font-bold text-gray-600 group-hover:text-sky-600 text-lg pl-2">
                         {option}
                       </span>
                       <div className="w-8 h-8 rounded-full bg-white border-2 border-gray-200 group-hover:border-sky-400 flex items-center justify-center transition-colors">
                         <div className="w-3 h-3 rounded-full bg-sky-400 opacity-0 group-hover:opacity-100 transition-opacity transform scale-0 group-hover:scale-100"></div>
                       </div>
                     </div>
                   </button>
                 ))}
               </div>
            </div>

            {questionSequence.length === 3 && currentQuestionIdx === 2 && (
              <div className="absolute top-20 right-0 m-4 animate-bounce">
                <span className="flex items-center gap-1 bg-rose-100 text-rose-500 px-4 py-1.5 rounded-full text-sm font-bold shadow-sm border border-rose-200">
                  <Star size={14} className="fill-current"/> åŠ åˆ†é¡Œï¼
                </span>
              </div>
            )}
          </div>
        </div>
      </div>
    );
  }

  // 3. è³‡æ–™å¡«å¯«é  - é¦¬å¡é¾é¢¨æ ¼
  if (currentStep === 'submission') {
    return (
      <div className="min-h-screen bg-gradient-to-t from-violet-100 to-white flex items-center justify-center p-4 font-sans">
        <div className="max-w-md w-full bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border-4 border-white">
          <div className="bg-violet-400 p-8 text-white text-center">
            <h2 className="text-2xl font-bold flex justify-center items-center gap-2">
              <Award className="text-yellow-300" /> æ­å–œå®Œæˆï¼
            </h2>
            <p className="opacity-90 mt-2 text-sm font-medium">å¡«å¯«ä¸€ä¸‹è³‡æ–™ï¼Œçœ‹çœ‹ä½ çš„æˆæœå§ âœ¨</p>
          </div>
          <div className="p-8">
            <form onSubmit={handleSubmit} className="space-y-5">
              
              <div>
                <label className="block text-sm font-bold text-gray-500 mb-2 ml-2">ç­ç´š (ä¹å¹´ç´š)</label>
                <div className="relative">
                  <select 
                    value={userInfo.className}
                    onChange={(e) => setUserInfo({...userInfo, className: e.target.value})}
                    className="w-full p-4 bg-gray-50 border-2 border-gray-100 rounded-2xl appearance-none focus:ring-4 focus:ring-violet-100 focus:border-violet-300 outline-none text-lg text-gray-700 transition-all font-medium"
                  >
                    {[...Array(10)].map((_, i) => (
                      <option key={i+1} value={i+1}>{i+1} ç­</option>
                    ))}
                  </select>
                  <div className="absolute right-4 top-1/2 transform -translate-y-1/2 pointer-events-none text-gray-400">â–¼</div>
                </div>
              </div>

              <div>
                <label className="block text-sm font-bold text-gray-500 mb-2 ml-2">åº§è™Ÿ</label>
                <input 
                  type="number" 
                  min="1" 
                  max="50"
                  placeholder="è«‹è¼¸å…¥è™Ÿç¢¼..."
                  value={userInfo.seatNumber}
                  onChange={(e) => setUserInfo({...userInfo, seatNumber: e.target.value})}
                  className="w-full p-4 bg-gray-50 border-2 border-gray-100 rounded-2xl focus:ring-4 focus:ring-violet-100 focus:border-violet-300 outline-none text-lg text-gray-700 transition-all font-medium placeholder-gray-300"
                  required
                />
              </div>

              {submitError && (
                <div className="p-4 bg-rose-50 text-rose-500 rounded-2xl text-sm flex items-center gap-2 border border-rose-100">
                  <AlertCircle size={18}/> {submitError}
                </div>
              )}
              
              {!GOOGLE_SCRIPT_URL && (
                <div className="p-3 bg-amber-50 text-amber-600 rounded-xl text-xs text-center border border-amber-100">
                  âš ï¸ æ¨¡æ“¬æ¨¡å¼ï¼šè³‡æ–™ä¸æœƒå¯¦éš›ä¸Šå‚³
                </div>
              )}

              <button 
                type="submit"
                disabled={isSubmitting}
                className={`w-full py-4 px-6 rounded-2xl font-bold text-white shadow-lg flex items-center justify-center gap-2 transition-all mt-4
                  ${isSubmitting ? 'bg-gray-300 cursor-not-allowed' : 'bg-violet-400 hover:bg-violet-500 hover:shadow-violet-200 hover:-translate-y-1'}`}
              >
                {isSubmitting ? 'å‚³é€ä¸­...' : 'é€å‡ºä¸¦æŸ¥çœ‹çµæœ'} 
                {!isSubmitting && <Send size={18} />}
              </button>
            </form>
          </div>
        </div>
      </div>
    );
  }

  // 4. çµæœé  - é¦¬å¡é¾é¢¨æ ¼ + ç­‰ç´š C éš±è—é‚è¼¯
  if (currentStep === 'result') {
    const displayFeedback = storedFeedback.length > 0 ? storedFeedback : generateFeedbackData();

    return (
      <div className="min-h-screen bg-[#f8fafc] p-4 font-sans">
        <div className="max-w-3xl mx-auto space-y-6">
          
          {/* å·²å®Œæˆæç¤º & è­˜åˆ¥ç¢¼ */}
          <div className="bg-white rounded-[2rem] shadow-xl overflow-hidden border-4 border-white relative">
            {alreadyCompleted && (
              <div className="bg-amber-100 text-amber-700 text-center py-2 text-sm font-bold flex items-center justify-center gap-2">
                <Lock size={14}/> æ‚¨å·²å®Œæˆæ¸¬é©—
              </div>
            )}
            <div className="p-10 text-center bg-gradient-to-b from-green-50 to-white">
              <div className="inline-flex items-center justify-center w-20 h-20 bg-green-100 text-green-500 rounded-full mb-5 shadow-sm">
                <CheckCircle size={40} />
              </div>
              <h2 className="text-3xl font-extrabold text-gray-700 mb-2 tracking-tight">
                {userInfo.className ? `ä¹å¹´ ${userInfo.className} ç­ ${userInfo.seatNumber} è™Ÿ` : 'æ¸¬é©—å®Œæˆ'}
              </h2>
              <p className="text-gray-400 text-sm font-medium">åšå¾—å¥½ï¼ä»¥ä¸‹æ˜¯ä½ çš„å­¸ç¿’åˆ†æ</p>
              
              <div className="flex flex-col items-center justify-center mt-6 p-6 bg-white rounded-3xl w-full max-w-xs mx-auto border-2 border-dashed border-gray-200 shadow-inner">
                <span className="text-gray-400 text-xs uppercase tracking-widest font-bold mb-1">æ‚¨çš„å°ˆå±¬è­˜åˆ¥ç¢¼</span>
                <span className="text-4xl font-mono font-bold text-sky-500 tracking-widest">{randomId}</span>
                <span className="text-xs text-rose-400 mt-2 font-medium bg-rose-50 px-3 py-1 rounded-full">è¨˜å¾—æŠ„å¯«åœ¨å­¸ç¿’å–®ä¸Šå–”</span>
              </div>
            </div>
          </div>

          {/* è©•èªå€å¡Š */}
          {displayFeedback.map((item, index) => (
            <div key={index} className={`bg-white rounded-[2rem] shadow-sm p-8 border-4 transition-transform hover:scale-[1.01] duration-300
                 ${item.level === 'A' ? 'border-emerald-100' : 
                   item.level === 'B' ? 'border-sky-100' : 
                   'border-orange-50' // C ç­‰ç´šç”¨æ›´æŸ”å’Œçš„æ¡†ç·š
                  }`}>
              <div className="flex justify-between items-center mb-4">
                <h3 className={`text-xl font-bold flex items-center gap-2
                    ${item.level === 'A' ? 'text-emerald-600' : 
                      item.level === 'B' ? 'text-sky-600' : 
                      'text-orange-400'}`}>
                   {item.level === 'A' && <Star className="fill-current" size={20}/>}
                   {item.title}
                </h3>
                
                {/* é‚è¼¯ï¼šè‹¥ç‚º C å‰‡ä¸é¡¯ç¤ºç­‰ç´šæ¨™ç±¤ */}
                {item.level !== 'C' && (
                  <span className={`px-4 py-1.5 rounded-full text-sm font-bold shadow-sm
                    ${item.level === 'A' ? 'bg-emerald-100 text-emerald-600' : 
                      'bg-sky-100 text-sky-600'}`}>
                    è¡¨ç¾ç­‰ç´šï¼š{item.level}
                  </span>
                )}
              </div>
              <p className="text-gray-600 leading-relaxed text-justify whitespace-pre-wrap font-medium">
                {item.text}
              </p>
            </div>
          ))}

          {/* æ•™å¸«ç¸½çµ - æ¼¸å±¤å¡ç‰‡ */}
          <div className="bg-gradient-to-r from-violet-300 to-fuchsia-300 rounded-[2rem] shadow-lg p-8 text-white relative overflow-hidden">
             {/* èƒŒæ™¯è£é£¾ */}
             <div className="absolute top-0 right-0 w-40 h-40 bg-white/10 rounded-full translate-x-10 -translate-y-10 blur-xl"></div>

            <h3 className="text-xl font-bold mb-4 flex items-center gap-2 relative z-10">
              <Award size={24} className="text-yellow-200" /> è€å¸«çš„è©±
            </h3>
            <p className="leading-relaxed font-medium relative z-10 text-white/95">
              åœ¨ä¹å¹´ç´šé€™å€‹éšæ®µï¼Œæˆ‘å€‘å¸Œæœ›ä½ å­¸åˆ°çš„ä¸åªæ˜¯ã€Œç®—å°æ•¸å­¸é¡Œã€ï¼Œè€Œæ˜¯èƒ½é€£çµçœŸå¯¦ä¸–ç•Œã€‚
              <br className="my-3 block"/>
              å¸Œæœ›ä½ ç¾åœ¨å·²ç¶“æ‡‚å¾—ç‚ºä»€éº¼ 3 åˆ†é˜çš„æœªå£“ç¸®éŒ„éŸ³æª”æœƒé€™éº¼å¤§ï¼Œä»¥åŠç‚ºä»€éº¼æˆ‘å€‘éœ€è¦ MP3 æ ¼å¼ä¾†å£“ç¸®å®ƒã€‚
              æœŸå¾…é€™é–€èª²èƒ½å¹«åŠ©ä½ äº†è§£ç”Ÿæ´»ä¸­çš„æ•¸ä½ç§‘æŠ€ï¼Œå…¶å¯¦éƒ½æºè‡ªæ–¼é€™äº› 0 èˆ‡ 1 çš„åŸºç¤åŸç†ï¼
            </p>
          </div>
          
          <div className="text-center text-gray-400 text-xs py-6 font-medium">
            æ¸¬é©—çµæŸï¼Œè«‹é—œé–‰è¦–çª—æˆ–é€šçŸ¥è€å¸«ç™»è¨˜æˆç¸¾ âœ¨
          </div>
        </div>
      </div>
    );
  }

  return null;
}