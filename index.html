<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹å¹´ç´šè³‡è¨Šç§‘æŠ€ - æœŸæœ«é©æ€§è©•é‡</title>
    
    <!-- 1. å¼•å…¥ Tailwind CSS (æ¨£å¼) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. å¼•å…¥ React å’Œ ReactDOM (æ ¸å¿ƒ) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. å¼•å…¥ Babel (è®“ç€è¦½å™¨çœ‹æ‡‚ JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- è‡ªå®šç¾©æ¨£å¼èª¿æ•´ -->
    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .option-btn {
            transition: all 0.2s ease;
        }
        .option-btn:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        // --- åœ–ç¤ºå…ƒä»¶å®šç¾© ---
        const Icons = {
            CheckCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            AlertCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            ArrowRight: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>,
            BookOpen: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
            Calculator: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>,
            Layout: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" x2="21" y1="9" y2="9"/><line x1="9" x2="9" y1="21" y2="9"/></svg>,
            Award: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>,
            Send: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            Lock: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Star: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
            Heart: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>,
            Cloud: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>,
            Smile: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>,
            PenTool: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg>,
            MessageCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>,
            EyeOff: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>,
            Info: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></svg>,
            X: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>,
        };

        const { useState, useEffect } = React;
        const { CheckCircle, AlertCircle, ArrowRight, BookOpen, Calculator, Layout, Award, Send, Lock, Star, Heart, Cloud, Smile, PenTool, MessageCircle, EyeOff, Info, X } = Icons;

        // --- æ‡‰ç”¨ç¨‹å¼é‚è¼¯ ---
        
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzpZuCMZXJMAeu5EgcWCQROj8k-b7FMXDRTqlxZRI65sTtJJmGJ4dcGj7lq74iuxni9/exec"; 
        
        const DIMENSIONS = {
            CONCEPT: 'concept',
            COMPUTATION: 'computation',
            APPLICATION: 'application'
        };

        const FEEDBACK_LIBRARY = {
            [DIMENSIONS.CONCEPT]: {
                A: "ä½ åœ¨è³‡è¨Šç§‘æŠ€çš„é‚è¼¯ç†è§£ä¸Šè¡¨ç¾å“è¶Šï¼ä¸åƒ…èƒ½ç²¾ç¢ºæŒæ¡è³‡æ–™æ•¸ä½åŒ–ï¼ˆå–æ¨£èˆ‡é‡åŒ–ï¼‰çš„æ ¸å¿ƒåŸç†ï¼Œä¹Ÿèƒ½æ¸…æ¥šå€åˆ†é»é™£èˆ‡å‘é‡åœ–çš„å·®ç•°ã€‚",
                B: "æœ¬å­¸æœŸä½ å°é›»è…¦é‹ä½œåŸç†å·²æœ‰ç©©å›ºçš„åŸºç¤ï¼Œèƒ½ç†è§£ç¾å¯¦ä¸–ç•Œçš„è²éŸ³èˆ‡å½±åƒå¦‚ä½•è½‰æ›ç‚ºé›»è…¦ä¸­çš„ 0 èˆ‡ 1ï¼Œä½†åœ¨ç´°ç¯€åŸç†çš„è§£é‡‹ä¸Šå¯ä»¥æ›´ç²¾ç¢ºã€‚",
                C: "ä½ å·²ç¶“å»ºç«‹äº†é›»è…¦ä½¿ç”¨ 0 èˆ‡ 1 å„²å­˜è³‡æ–™çš„åŸºæœ¬æ¦‚å¿µã€‚å»ºè­°åœ¨æ•¸ä½åŒ–åŸç†ï¼ˆå¦‚è²éŸ³çš„å–æ¨£éç¨‹ï¼‰å¤šèŠ±é»æ™‚é–“è¤‡ç¿’ï¼Œé‡æ¸…å–æ¨£èˆ‡é‡åŒ–çš„å·®ç•°ã€‚"
            },
            [DIMENSIONS.COMPUTATION]: {
                A: "åœ¨äºŒé€²ä½é‹ç®—èˆ‡æª”æ¡ˆå®¹é‡ä¼°ç®—ä¸Šå±•ç¾äº†åš´è¬¹çš„é‹ç®—æ€ç¶­ï¼Œèƒ½éˆæ´»é‹ç”¨å…¬å¼è¨ˆç®—æœªå£“ç¸®éŸ³è¨Šå¤§å°ï¼Œä¸¦æ­£ç¢ºé€²è¡Œå–®ä½çš„æ›ç®—ã€‚",
                B: "åœ¨é€²ä½åˆ¶è½‰æ›è¨ˆç®—ä¸Šå¤§è‡´æ­£ç¢ºï¼Œå”¯åœ¨è¤‡é›œçš„å–®ä½æ›ç®—ï¼ˆå¦‚ bits è½‰ MBï¼‰ç´°ç¯€ä¸Šå¯å†ç´°å¿ƒä¸€é»ï¼Œå…¬å¼é‹ç”¨å°šç¨±ç†Ÿç·´ã€‚",
                C: "å»ºè­°å¤šç·´ç¿’äºŒé€²ä½çš„è¨ˆç®—è¦å‰‡ï¼Œä¸¦è©¦è‘—ææ‡‚ bit èˆ‡ Byte çš„å€æ•¸å·®ç•°ï¼Œé€™å°æ–¼æœªä¾†è©•ä¼°æ‰‹æ©Ÿæˆ–é›»è…¦å®¹é‡éå¸¸é‡è¦ã€‚"
            },
            [DIMENSIONS.APPLICATION]: {
                A: "ä½ å°æ–¼ä¸åŒæ–‡å­—ç·¨ç¢¼ï¼ˆUnicode/Big-5ï¼‰èˆ‡å½±åƒæ ¼å¼çš„ç‰¹æ€§ç­è‹¥æŒ‡æŒï¼Œèƒ½é‡å°ä¸åŒéœ€æ±‚åšå‡ºæœ€ä½³çš„æŠ€è¡“é¸æ“‡ï¼Œå…·å‚™å„ªç§€çš„æ•¸ä½å…¬æ°‘ç´ é¤Šã€‚",
                B: "å°æ–¼å¸¸è¦‹çš„æª”æ¡ˆæ ¼å¼ï¼ˆJPG, MP3ï¼‰æœ‰åŸºæœ¬èªè­˜ï¼Œè‹¥èƒ½é€²ä¸€æ­¥æ·±ç©¶ä¸åŒç·¨ç¢¼ç³»çµ±ï¼ˆå¦‚äº‚ç¢¼åŸå› ï¼‰çš„å·®ç•°ï¼Œä½ çš„è³‡è¨Šç´ é¤Šå°‡æ›´ä¸Šä¸€å±¤æ¨“ã€‚",
                C: "å°æ–¼æª”æ¡ˆæ ¼å¼çš„ç”¨é€”èˆ‡æ–‡å­—ç·¨ç¢¼çš„æ¦‚å¿µè¼ƒç‚ºæ¨¡ç³Šï¼Œå»ºè­°å¤šè§€å¯Ÿç”Ÿæ´»ä¸­çš„æª”æ¡ˆé™„æª”åï¼Œå°‡æœ‰åŠ©æ–¼ç†è§£é€™äº›æ•¸ä½å·¥å…·çš„ç‰¹æ€§ã€‚"
            }
        };

        // --- å®Œæ•´é¡Œåº« (å…± 8 å€‹å–®å…ƒï¼Œ24 é¡Œï¼Œå¹³å‡åˆ†é… A/B/C/D) ---
        const QUIZ_DATA = [
            // å–®å…ƒ 1: è²éŸ³æ•¸ä½åŒ–åŸç† (åŸºç¤)
            {
                id: 'c1',
                title: 'è²éŸ³æ•¸ä½åŒ–ï¼šå–æ¨£èˆ‡æ ¼å¼',
                dimension: DIMENSIONS.CONCEPT,
                questions: [
                    { id: 'q1-1', type: 'MC', text: 'ä¸€èˆ¬é›»è©±çš„é€šè©±å–æ¨£é »ç‡æ˜¯ 8kHzï¼Œä»£è¡¨ 1 ç§’é˜è¦é€²è¡Œå¹¾æ¬¡å–æ¨£ï¼Ÿ', options: ['8,000 æ¬¡', '8 æ¬¡', '800 æ¬¡', '80,000 æ¬¡'], correctAnswer: '8,000 æ¬¡' }, // Ans: A
                    { id: 'q1-2', type: 'MC', text: 'åŒä¸€æ®µè²éŸ³ï¼Œä»¥ä¸‹åˆ—ä½•ç¨®æ ¼å¼éŒ„è£½ï¼Œå®ƒçš„æª”æ¡ˆæœ€å¤§ (æœªç¶“å£“ç¸®)ï¼Ÿ', options: ['MIDI(.mid)', 'WAV(.wav)', 'MP3(.mp3)', 'DOC(.doc)'], correctAnswer: 'WAV(.wav)' }, // Ans: B
                    { id: 'q1-3', type: 'TF', text: 'è²éŸ³çš„ã€Œå–æ¨£ã€æ˜¯æŒ‡ï¼šåœ¨ä¸€å®šçš„æ™‚é–“å…§ï¼ŒæŒ‡å®šè¦æ”¶é›†æˆ–è¨˜éŒ„å¤šå°‘æ¬¡è²éŸ³çš„è¨Šè™Ÿã€‚', options: ['æ­£ç¢º', 'éŒ¯èª¤'], correctAnswer: 'æ­£ç¢º' } // Ans: A (True)
                ]
            },
            // å–®å…ƒ 2: è²éŸ³æ•¸ä½åŒ–åŸç† (é€²éš)
            {
                id: 'c2',
                title: 'è²éŸ³æ•¸ä½åŒ–ï¼šå“è³ªèˆ‡é‡åŒ–',
                dimension: DIMENSIONS.CONCEPT,
                questions: [
                    { id: 'q2-1', type: 'MC', text: 'è‹¥è¦æé«˜éŒ„éŸ³çš„å“è³ªï¼Œä½¿å…¶æ›´æ¥è¿‘åŸéŸ³ï¼Œæ‡‰è©²å¦‚ä½•èª¿æ•´ï¼Ÿ', options: ['é™ä½å–æ¨£é »ç‡èˆ‡è§£æåº¦', 'ä¸æ”¹è®Šå–æ¨£é »ç‡ä½†é™ä½è§£æåº¦', 'æé«˜å–æ¨£é »ç‡èˆ‡è§£æåº¦', 'åªæé«˜è§£æåº¦'], correctAnswer: 'æé«˜å–æ¨£é »ç‡èˆ‡è§£æåº¦' }, // Ans: C
                    { id: 'q2-2', type: 'MC', text: 'æ”¶é›†åˆ°è²â¾³è³‡æ–™å¾Œï¼Œå†æŠŠè³‡æ–™è½‰æ›æˆæ•¸ä½çš„å½¢æ…‹(0æˆ–1)ï¼Œé€™å€‹éç¨‹ç¨±ç‚ºä»€éº¼ï¼Ÿ', options: ['å–æ¨£', 'é‡åŒ–', 'æ•¸å­—åŒ–', 'â½‚å­—åŒ–'], correctAnswer: 'é‡åŒ–' }, // Ans: B
                    { id: 'q2-3', type: 'MC', text: 'è‹¥è¦è¨ˆç®—æœªå£“ç¸®è²éŸ³æª”çš„å¤§å°ï¼Œå…¬å¼ä¸­ã€Œä¸éœ€è¦ã€åŒ…å«ä¸‹åˆ—å“ªä¸€é …ï¼Ÿ', options: ['éº¥å…‹é¢¨çš„å» ç‰Œ', 'éŒ„éŸ³æ™‚é–“é•·åº¦', 'å–æ¨£é »ç‡', 'ä½å…ƒæ·±åº¦'], correctAnswer: 'éº¥å…‹é¢¨çš„å» ç‰Œ' } // Ans: A
                ]
            },
            // å–®å…ƒ 3: å½±åƒæ•¸ä½åŒ– (åŸºç¤)
            {
                id: 'c3',
                title: 'æ•¸ä½å½±åƒï¼šå‘é‡èˆ‡é»é™£',
                dimension: DIMENSIONS.CONCEPT,
                questions: [
                    { id: 'q3-1', type: 'MC', text: 'è«‹å•ä»¥ã€Œæ•¸å­¸å…¬å¼ã€è¨˜éŒ„å½±åƒè³‡è¨Šçš„ç‚ºä¸‹åˆ—ä½•ç¨®å½±åƒé¡å‹ï¼Ÿ', options: ['é»é™£åœ–', 'å‘é‡åœ–', 'æŸæ‹‰åœ–', 'è¥¿é›…åœ–'], correctAnswer: 'å‘é‡åœ–' }, // Ans: B
                    { id: 'q3-2', type: 'MC', text: 'æ‰‹æ©Ÿæ‹å‡ºä¾†çš„ç…§ç‰‡ï¼Œé€šå¸¸æ˜¯å±¬æ–¼å“ªä¸€ç¨®é¡å‹çš„åœ–æª”ï¼Ÿ', options: ['å‘é‡åœ– (Vector)', 'GIF å‹•ç•«', 'é»é™£åœ– (Bitmap)', 'SVG åœ–æª”'], correctAnswer: 'é»é™£åœ– (Bitmap)' }, // Ans: C
                    { id: 'q3-3', type: 'TF', text: 'ã€Œå‘é‡åœ–ã€æ”¾å¤§å¾Œé‚Šç·£æœƒç”¢ç”Ÿé‹¸é½’ç‹€çš„å¤±çœŸï¼Œä¸é©åˆç”¨æ–¼å¤§åœ–è¼¸å‡ºã€‚', options: ['æ­£ç¢º', 'éŒ¯èª¤'], correctAnswer: 'éŒ¯èª¤' } // Ans: B (False)
                ]
            },
            // å–®å…ƒ 4: å½±åƒæ•¸ä½åŒ– (é‹ç®—)
            {
                id: 'c4',
                title: 'æ•¸ä½å½±åƒï¼šè§£æåº¦èˆ‡è‰²å½©',
                dimension: DIMENSIONS.COMPUTATION,
                questions: [
                    { id: 'q4-1', type: 'MC', text: 'è‹¥å°‡ 4x6 çš„ç…§ç‰‡ï¼Œç”¨æƒæå™¨ä»¥ 300DPI é€²è¡Œæ•¸ä½åŒ–ï¼Œè«‹å•å…¶æ•¸ä½åŒ–å¾Œçš„å½±åƒã€Œé•·é‚Šã€æœƒæ˜¯å¤šå°‘ Dots (åƒç´ )ï¼Ÿ', options: ['1800', '1200', '75', '50'], correctAnswer: '1800' }, // Ans: A
                    { id: 'q4-2', type: 'MC', text: 'è«‹å•å½©è‰²å½±åƒå¦‚æœä»¥ 8 ä½å…ƒä¾†è¨˜éŒ„æ¯ä¸€ç¨®è‰²å…‰ (R, G, B)ï¼Œé‚£éº¼ç•«é¢ä¸­çš„æ¯ä¸€å€‹åƒç´ æœƒä½¿ç”¨å¤šå°‘ä½å…ƒä¾†è¡¨ç¤ºè‰²å½©ï¼Ÿ', options: ['8 ä½å…ƒ', '24 ä½å…ƒ', '32 ä½å…ƒ', '16 ä½å…ƒ'], correctAnswer: '24 ä½å…ƒ' }, // Ans: B
                    { id: 'q4-3', type: 'MC', text: 'å“ªä¸€ç¨®åœ–æª”æ˜¯é€éæ•¸å­¸å…¬å¼ä¾†ç´€éŒ„åœ–å½¢çš„å½¢ç‹€èˆ‡é¡è‰²ï¼Ÿ', options: ['é»é™£åœ–', 'æŸæ‹‰åœ–', 'å‘é‡åœ–', 'è¥¿é›…åœ–'], correctAnswer: 'å‘é‡åœ–' } // Ans: C
                ]
            },
            // å–®å…ƒ 5: è³‡æ–™è¡¨ç¤º (åŸºç¤é‹ç®—)
            {
                id: 'c5',
                title: 'è³‡æ–™è¡¨ç¤ºï¼šåŸºç¤äºŒé€²ä½',
                dimension: DIMENSIONS.COMPUTATION,
                questions: [
                    { id: 'q5-1', type: 'TF', text: 'é›»è…¦å…§éƒ¨è™•ç†è³‡æ–™æ™‚ï¼Œä¸»è¦æ˜¯ä½¿ç”¨ã€Œåé€²ä½ã€ç³»çµ±ã€‚', options: ['æ­£ç¢º', 'éŒ¯èª¤'], correctAnswer: 'éŒ¯èª¤' }, // Ans: B (False)
                    { id: 'q5-2', type: 'MC', text: 'åé€²ä½çš„æ•¸å­—ã€Œ3ã€ï¼Œè½‰æ›æˆäºŒé€²ä½æ˜¯å¤šå°‘ï¼Ÿ', options: ['10', '00', '01', '11'], correctAnswer: '11' }, // Ans: D
                    { id: 'q5-3', type: 'MC', text: 'äºŒé€²ä½çš„ã€Œ100ã€ï¼Œè½‰æ›æˆåé€²ä½æ˜¯å¤šå°‘ï¼Ÿ', options: ['8', '2', '6', '4'], correctAnswer: '4' } // Ans: D
                ]
            },
            // å–®å…ƒ 6: è³‡æ–™è¡¨ç¤º (é€²éšé‹ç®—)
            {
                id: 'c6',
                title: 'è³‡æ–™è¡¨ç¤ºï¼šé€²éšé‹ç®—',
                dimension: DIMENSIONS.COMPUTATION,
                questions: [
                    { id: 'q6-1', type: 'MC', text: '(10010)â‚‚ï¼Œæ›ç®—æˆåé€²ä½æ˜¯å¤šå°‘ï¼Ÿ', options: ['18', '12', '20', '16'], correctAnswer: '18' }, // Ans: A
                    { id: 'q6-2', type: 'MC', text: 'æ­£æ•´æ•¸ 9 ç¶“éæ•¸ä½åŒ–å¾Œï¼Œè‹¥ä»¥ã€Œ8 ä½å…ƒã€çš„æ ¼å¼ä¾†è¡¨ç¤ºï¼Œæ‡‰è©²æœƒæ˜¯å¤šå°‘ï¼Ÿ', options: ['1001', '00001001', '10010000', '00001010'], correctAnswer: '00001001' }, // Ans: B
                    { id: 'q6-3', type: 'MC', text: '1 Byte (ä½å…ƒçµ„) ç­‰æ–¼å¤šå°‘ bits (ä½å…ƒ)ï¼Ÿ', options: ['10 bits', '16 bits', '8 bits', '4 bits'], correctAnswer: '8 bits' } // Ans: C
                ]
            },
            // å–®å…ƒ 7: ç³»çµ±æ‡‰ç”¨ (ç·¨ç¢¼)
            {
                id: 'c7',
                title: 'ç³»çµ±æ‡‰ç”¨ï¼šç·¨ç¢¼åŸç†',
                dimension: DIMENSIONS.APPLICATION,
                questions: [
                    { id: 'q7-1', type: 'MC', text: 'è«‹å•ä»¥ä¸‹å“ªä¸€å€‹ç·¨ç¢¼ç³»çµ±çš„æ¨å‡ºï¼Œæ˜¯ç‚ºäº†è®“é›»è…¦èƒ½åŒæ™‚è™•ç†å¤šåœ‹èªè¨€æ··ç”¨çš„æƒ…æ³ (è§£æ±ºäº‚ç¢¼)ï¼Ÿ', options: ['ASCII', 'Big-5', 'ANSI-8', 'Unicode'], correctAnswer: 'Unicode' }, // Ans: D
                    { id: 'q7-2', type: 'MC', text: 'è‹¥ç¶²é å‡ºç¾äº‚ç¢¼ï¼Œé€šå¸¸æ˜¯å› ç‚ºå“ªå…©ç¨®ç·¨ç¢¼ç³»çµ±è¡çªï¼Ÿ', options: ['Big-5 èˆ‡ Unicode', 'RGB èˆ‡ CMYK', 'Windows èˆ‡ MacOS', 'JPG èˆ‡ GIF'], correctAnswer: 'Big-5 èˆ‡ Unicode' }, // Ans: A
                    { id: 'q7-3', type: 'MC', text: 'æƒ³è¦è£½ä½œèƒŒæ™¯é€æ˜çš„åœ–ç¤ºï¼Œæ‡‰è©²é¸æ“‡å“ªç¨®æª”æ¡ˆæ ¼å¼ï¼Ÿ', options: ['JPG', 'GIF', 'PNG', 'BMP'], correctAnswer: 'PNG' } // Ans: C
                ]
            },
            // å–®å…ƒ 8: ç¶œåˆè§€å¿µ
            {
                id: 'c8',
                title: 'ç¶œåˆè§€å¿µèˆ‡å„²å­˜',
                dimension: DIMENSIONS.APPLICATION,
                questions: [
                    { id: 'q8-1', type: 'TF', text: 'åœ¨å„²å­˜å–®ä½ä¸­ï¼Œ1 GB çš„å®¹é‡æ¯” 1 MB é‚„è¦å°ã€‚', options: ['æ­£ç¢º', 'éŒ¯èª¤'], correctAnswer: 'éŒ¯èª¤' }, // Ans: B (False)
                    { id: 'q8-2', type: 'MC', text: 'æ•¸ä½å½±åƒä¸»è¦æ˜¯ç”±å“ªä¸‰ç¨®ã€Œè‰²å…‰ã€æ‰€æ··åˆè€Œæˆï¼Ÿ', options: ['ç´…ã€ç¶ ã€è—', 'ç´…ã€é»ƒã€è—', 'é’ã€æ´‹ç´…ã€é»ƒ', 'ç´…ã€ç™½ã€é»‘'], correctAnswer: 'ç´…ã€ç¶ ã€è—' }, // Ans: A (RGB)
                    { id: 'q8-3', type: 'MC', text: 'ä¸‹åˆ—ä½•è€…æ˜¯é›»è…¦å„²å­˜è³‡æ–™çš„æœ€å°å–®ä½ï¼Ÿ', options: ['Byte (ä½å…ƒçµ„)', 'KG', 'KM', 'bit (ä½å…ƒ)'], correctAnswer: 'bit (ä½å…ƒ)' } // Ans: D
                ]
            }
        ];

        const SURVEY_QUESTIONS = [
            { id: 's1', icon: <Smile size={24}/>, text: 'æˆ‘ä¸Šèª²èƒ½å°ˆå¿ƒåƒèˆ‡', options: ['ç¸½æ˜¯åšåˆ°', 'ç¶“å¸¸åšåˆ°', 'å¶çˆ¾åšåˆ°', 'è¼ƒå°‘åšåˆ°'] },
            { id: 's2', icon: <PenTool size={24}/>, text: 'æˆ‘èƒ½å®Œæˆç•¶æ¬¡ä½œæ¥­', options: ['ç¸½æ˜¯åšåˆ°', 'ç¶“å¸¸åšåˆ°', 'å¶çˆ¾åšåˆ°', 'è¼ƒå°‘åšåˆ°'] },
            { id: 's3', icon: <MessageCircle size={24}/>, text: 'é‡åˆ°å•é¡Œï¼Œæˆ‘æœƒå•è€å¸«', options: ['ç¸½æ˜¯åšåˆ°', 'ç¶“å¸¸åšåˆ°', 'å¶çˆ¾åšåˆ°', 'è¼ƒå°‘åšåˆ°'] }
        ];

        const generateRandomId = () => Math.floor(10000 + Math.random() * 90000).toString();

        const formatTime = (seconds) => {
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}åˆ†${s}ç§’`;
        };

        // é¸é …è™•ç†å‡½å¼
        const manipulateOptions = (array) => {
            if (array.length === 2) {
                return [array[1], array[0]];
            }
            // Fisher-Yates Shuffle
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        };

        // æ ¸å¿ƒé‚è¼¯ï¼šç”¢ç”Ÿå¹³è¡¡ä¸”éš¨æ©Ÿçš„é¸é …æ˜ å°„
        const generateBalancedOptions = (quizData) => {
            const map = {};
            const mcQuestions = []; // 4 options
            const tfQuestions = []; // 2 options

            quizData.forEach(c => {
                c.questions.forEach(q => {
                    if (q.type === 'MC') mcQuestions.push(q);
                    else tfQuestions.push(q);
                });
            });

            // 1. ç‚ºé¸æ“‡é¡Œç”¢ç”Ÿå¹³è¡¡çš„ç­”æ¡ˆä½ç½®æ§½ (20é¡Œ -> å„5å€‹ 0,1,2,3)
            let mcSlots = [];
            const baseCount = Math.floor(mcQuestions.length / 4);
            const remainder = mcQuestions.length % 4;
            
            for(let i=0; i<4; i++) {
                for(let j=0; j<baseCount; j++) mcSlots.push(i);
            }
            for(let k=0; k<remainder; k++) mcSlots.push(k);
            
            mcSlots = shuffleArray(mcSlots);

            // 2. ç‚ºæ˜¯éé¡Œç”¢ç”Ÿå¹³è¡¡ä½ç½® (4é¡Œ -> å„2å€‹)
            let tfSlots = [0,0,1,1];
            tfSlots = shuffleArray(tfSlots);

            // 3. åˆ†é…ä¸¦æ´—ç‰Œå¹²æ“¾é …
            mcQuestions.forEach((q, idx) => {
                const correctPos = mcSlots[idx]; // æŒ‡å®šçš„æ­£ç¢ºç­”æ¡ˆä½ç½®
                const distractors = q.options.filter(o => o !== q.correctAnswer);
                const shuffledDistractors = shuffleArray(distractors); // å¹²æ“¾é …ä¹Ÿæ´—ç‰Œ
                
                const finalOptions = new Array(4);
                finalOptions[correctPos] = q.correctAnswer;
                let distIdx = 0;
                for(let i=0; i<4; i++){
                    if(i !== correctPos) finalOptions[i] = shuffledDistractors[distIdx++];
                }
                map[q.id] = finalOptions;
            });

            tfQuestions.forEach((q, idx) => {
                const correctPos = tfSlots[idx];
                const otherOption = q.options.find(o => o !== q.correctAnswer);
                const finalOptions = new Array(2);
                finalOptions[correctPos] = q.correctAnswer;
                finalOptions[1-correctPos] = otherOption;
                map[q.id] = finalOptions;
            });

            return map;
        };
        
        // ç°¡å–®çš„æ´—ç‰Œå‡½å¼
        const shuffleArray = (array) => {
            const newArr = [...array];
            for (let i = newArr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
            }
            return newArr;
        };

        // é¡Œç›®æ˜ å°„ (ID -> åºè™Ÿ)
        const getQuestionNumberMap = () => {
            const map = {};
            let count = 1;
            QUIZ_DATA.forEach(c => {
                c.questions.forEach(q => {
                    map[q.id] = count++;
                });
            });
            return map;
        };

        const STORAGE_KEY = 'ninth_grade_assessment_v21'; // æ›´æ–°ç‰ˆæœ¬è™Ÿ

        // ç°¡å–®çš„ç„¡ç—•æ¨¡å¼åµæ¸¬
        const detectIncognito = async () => {
            try {
                if ('storage' in navigator && 'estimate' in navigator.storage) {
                    const { usage, quota } = await navigator.storage.estimate();
                    if (quota < 120000000) return true;
                }
                return false;
            } catch(e) {
                return false;
            }
        };

        function AssessmentApp() {
            const [currentStep, setCurrentStep] = useState('loading'); 
            const [currentConceptIndex, setCurrentConceptIndex] = useState(0);
            const [questionSequence, setQuestionSequence] = useState([]); 
            const [currentQuestionIdx, setCurrentQuestionIdx] = useState(0);
            const [answers, setAnswers] = useState({});
            const [scores, setScores] = useState({});
            const [speedViolations, setSpeedViolations] = useState({});
            const [trackingLog, setTrackingLog] = useState({});
            const [sessionOptions, setSessionOptions] = useState({}); 
            
            const [startTime, setStartTime] = useState(null); 
            const [endTime, setEndTime] = useState(null);
            const [questionStartTime, setQuestionStartTime] = useState(null); 
            
            const [userInfo, setUserInfo] = useState({ className: '1', seatNumber: '' });
            const [surveyAnswers, setSurveyAnswers] = useState({});
            const [randomId, setRandomId] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [submitError, setSubmitError] = useState('');
            const [alreadyCompleted, setAlreadyCompleted] = useState(false);
            const [storedFeedback, setStoredFeedback] = useState([]); 
            
            const [isIncognito, setIsIncognito] = useState(false);
            const [isDuplicate, setIsDuplicate] = useState(false);
            const [showDuplicateModal, setShowDuplicateModal] = useState(false);

            useEffect(() => {
                const init = async () => {
                    const incognito = await detectIncognito();
                    if (incognito) {
                        setIsIncognito(true);
                        setCurrentStep('incognito_blocked');
                        return;
                    }

                    // *** ç”¢ç”Ÿéš¨æ©Ÿä¸”å¹³è¡¡çš„é¸é … ***
                    const balancedOpts = generateBalancedOptions(QUIZ_DATA);
                    setSessionOptions(balancedOpts);

                    const savedData = localStorage.getItem(STORAGE_KEY);
                    if (savedData) {
                        try {
                            const parsedData = JSON.parse(savedData);
                            if (parsedData.completed) {
                                setRandomId(parsedData.randomId || '');
                                setUserInfo(parsedData.userInfo || { className: '1', seatNumber: '' });
                                setStoredFeedback(parsedData.feedbackList || []);
                                
                                setAlreadyCompleted(true);
                                setIsDuplicate(true);
                                setShowDuplicateModal(true);
                                setCurrentStep('result');
                                return;
                            }
                        } catch (e) {
                            console.error("Local storage parse error", e);
                            localStorage.removeItem(STORAGE_KEY);
                        }
                    }
                    setCurrentStep('intro');
                };
                init();
            }, []);

            useEffect(() => {
                if (currentStep === 'quiz' && questionSequence.length > 0) {
                    setQuestionStartTime(Date.now());
                }
            }, [currentQuestionIdx, currentStep, questionSequence]);

            useEffect(() => {
                if (currentStep === 'quiz' && currentConceptIndex === 0 && currentQuestionIdx === 0 && !startTime) {
                    setStartTime(Date.now());
                }
                if (currentStep === 'quiz') {
                    loadConcept(currentConceptIndex || 0);
                }
            }, [currentStep]);

            const loadConcept = (index) => {
                if (index >= QUIZ_DATA.length) {
                    setCurrentStep('survey');
                    return;
                }
                setCurrentConceptIndex(index);
                const concept = QUIZ_DATA[index];
                if (questionSequence.length === 0 || QUIZ_DATA[index].id !== QUIZ_DATA[currentConceptIndex]?.id) {
                    setQuestionSequence([concept.questions[0], concept.questions[1]]);
                    setCurrentQuestionIdx(0);
                }
            };

            const handleAnswer = (option) => {
                const now = Date.now();
                const timeSpent = now - questionStartTime;
                const currentConcept = QUIZ_DATA[currentConceptIndex];
                const currentQ = questionSequence[currentQuestionIdx];
                const isCorrectChoice = option === currentQ.correctAnswer;
                const timeSpentSec = (timeSpent / 1000).toFixed(1);

                if (timeSpent < 3000 && !currentQ.isRetry) {
                    setTrackingLog(prev => ({
                        ...prev,
                        [currentQ.id]: {
                            option: option,
                            time: timeSpentSec,
                            violation: true
                        }
                    }));

                    const retryQ = {
                        ...currentQ,
                        isRetry: true,
                        options: shuffleArray(currentQ.options), // é‡è©¦é¡Œå†æ¬¡æ´—ç‰Œ
                        firstAttemptCorrect: isCorrectChoice
                    };
                    
                    setQuestionSequence(prev => [...prev, retryQ]);
                    setCurrentQuestionIdx(currentQuestionIdx + 1);
                    return;
                }

                let finalIsCorrect = isCorrectChoice;

                if (currentQ.isRetry) {
                    if (timeSpent < 3000) {
                        if (!currentQ.firstAttemptCorrect || !isCorrectChoice) {
                            finalIsCorrect = false; 
                        }
                    }
                } 

                setTrackingLog(prev => ({
                    ...prev,
                    [currentQ.id]: {
                        option: option,
                        time: timeSpentSec,
                        violation: timeSpent < 3000
                    }
                }));

                const newAnswers = { ...answers, [currentQ.id]: finalIsCorrect };
                setAnswers(newAnswers);

                if (currentQuestionIdx === 1) { 
                    const q1Result = newAnswers[currentConcept.questions[0].id];
                    const q2Result = finalIsCorrect; 
                    
                    let nextSequence = [...questionSequence];
                    
                    if (q1Result !== q2Result) {
                        nextSequence.push(currentConcept.questions[2]); 
                        setQuestionSequence(nextSequence);
                        setCurrentQuestionIdx(currentQuestionIdx + 1);
                    } else {
                        goToNextConcept(currentConcept.id, newAnswers, nextSequence);
                    }
                } else if (currentQuestionIdx >= questionSequence.length - 1) { 
                    goToNextConcept(currentConcept.id, newAnswers, questionSequence);
                } else {
                    setCurrentQuestionIdx(currentQuestionIdx + 1);
                }
            };

            const goToNextConcept = (conceptId, currentAnswers, sequence) => {
                let correctCount = 0;
                const uniqueQuestions = new Map();
                sequence.forEach(q => uniqueQuestions.set(q.id, q));

                uniqueQuestions.forEach((q, id) => {
                    if (currentAnswers[id]) correctCount++;
                });

                setScores(prev => ({
                    ...prev,
                    [conceptId]: { correct: correctCount, total: uniqueQuestions.size }
                }));

                setQuestionSequence([]); 
                setCurrentQuestionIdx(0);
                loadConcept(currentConceptIndex + 1);
            };

            const handleSurveyAnswer = (questionId, option) => {
                setSurveyAnswers(prev => ({
                    ...prev,
                    [questionId]: option
                }));
            };
            
            const finishSurvey = () => {
                if (Object.keys(surveyAnswers).length < SURVEY_QUESTIONS.length) {
                    alert("è«‹å®Œæˆæ‰€æœ‰å•é¡Œå–”ï¼");
                    return;
                }
                setEndTime(Date.now());
                setCurrentStep('submission');
            };

            const generateFeedbackData = () => {
                let dimensionScores = {
                    [DIMENSIONS.CONCEPT]: { correct: 0, total: 0 },
                    [DIMENSIONS.COMPUTATION]: { correct: 0, total: 0 },
                    [DIMENSIONS.APPLICATION]: { correct: 0, total: 0 }
                };

                QUIZ_DATA.forEach(concept => {
                    const score = scores[concept.id];
                    if (score) {
                        dimensionScores[concept.dimension].correct += score.correct;
                        dimensionScores[concept.dimension].total += score.total;
                    }
                });

                const feedbackList = Object.values(DIMENSIONS).map(dim => {
                    const { correct, total } = dimensionScores[dim] || { correct: 0, total: 0 };
                    const percentage = total === 0 ? 0 : (correct / total);
                    let level = 'C';
                    if (percentage >= 0.8) level = 'A';
                    else if (percentage >= 0.5) level = 'B';
                    
                    let title = "";
                    if(dim === DIMENSIONS.CONCEPT) title = "ä¸€ã€æ•¸ä½åŒ–åŸç†çš„ç†è§£";
                    if(dim === DIMENSIONS.COMPUTATION) title = "äºŒã€é‹ç®—æ€ç¶­èˆ‡æ•¸å€¼è½‰æ›";
                    if(dim === DIMENSIONS.APPLICATION) title = "ä¸‰ã€ç³»çµ±æ‡‰ç”¨èˆ‡ç·¨ç¢¼ç´ é¤Š";

                    let feedbackText = FEEDBACK_LIBRARY[dim][level];

                    if (speedViolations[dim]) {
                        feedbackText = "ç­”é¡Œé€Ÿåº¦éå¿«ï¼Œé›£ä»¥è©•æ–·";
                    }

                    return {
                        dim,
                        title,
                        level,
                        text: feedbackText
                    };
                });

                return feedbackList;
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!userInfo.seatNumber) {
                    alert("è«‹è¼¸å…¥åº§è™Ÿï¼");
                    return;
                }

                setIsSubmitting(true);
                setSubmitError('');

                const feedbackList = generateFeedbackData();
                const generatedRandomId = generateRandomId();
                const durationSeconds = (endTime - startTime) / 1000;
                const formattedTime = formatTime(durationSeconds);
                const teacherSummaryText = "åœ¨ä¹å¹´ç´šé€™å€‹éšæ®µï¼Œè©•é‡çš„æ ¸å¿ƒä¸æ‡‰åªæ˜¯ã€Œç®—å°æ•¸å­¸é¡Œã€ï¼Œè€Œæ˜¯ã€Œé€£çµçœŸå¯¦ä¸–ç•Œã€ã€‚å¸Œæœ›ä½ ç¾åœ¨å·²ç¶“æ‡‚å¾—ç‚ºä»€éº¼ 3 åˆ†é˜çš„æœªå£“ç¸®éŒ„éŸ³æª”æœƒé€™éº¼å¤§ï¼Œä»¥åŠç‚ºä»€éº¼æˆ‘å€‘éœ€è¦ MP3 æ ¼å¼ä¾†å£“ç¸®å®ƒã€‚";

                const surveyText = SURVEY_QUESTIONS.map(q => `[åæ€] ${q.text}ï¼š${surveyAnswers[q.id] || ''}`).join("\n");
                const fullFeedbackText = feedbackList.map(f => `[${f.title}] ${f.text}`).join("\n") + "\n\n" + surveyText;

                const qMap = getQuestionNumberMap();
                const correctList = Object.keys(answers)
                    .filter(id => answers[id])
                    .map(id => qMap[id])
                    .sort((a, b) => a - b)
                    .join(", ");
                const incorrectList = Object.keys(answers)
                    .filter(id => !answers[id])
                    .map(id => qMap[id])
                    .sort((a, b) => a - b)
                    .join(", ");

                const trackingString = Object.keys(trackingLog)
                    .map(id => {
                        const log = trackingLog[id];
                        const qNum = qMap[id] || id;
                        const violationMark = log.violation ? '[å¿«ç­”]' : '';
                        return `Q${qNum}:${log.option}(${log.time}s)${violationMark}`;
                    })
                    .join(" | ");

                const payload = {
                    className: `ä¹å¹´${userInfo.className}ç­`,
                    seatNumber: userInfo.seatNumber,
                    conceptLevel: feedbackList.find(f => f.dim === DIMENSIONS.CONCEPT)?.level,
                    computationLevel: feedbackList.find(f => f.dim === DIMENSIONS.COMPUTATION)?.level,
                    applicationLevel: feedbackList.find(f => f.dim === DIMENSIONS.APPLICATION)?.level,
                    feedbackText: fullFeedbackText,
                    teacherSummary: teacherSummaryText,
                    totalTime: formattedTime,
                    randomId: generatedRandomId,
                    correctQuestions: correctList,
                    incorrectQuestions: incorrectList,
                    trackingDetails: trackingString
                };

                try {
                    if (!isDuplicate && GOOGLE_SCRIPT_URL) {
                        await fetch(GOOGLE_SCRIPT_URL, {
                            method: 'POST',
                            mode: 'no-cors', 
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                    } else {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }

                    setRandomId(generatedRandomId);
                    setStoredFeedback(feedbackList);
                    
                    localStorage.setItem(STORAGE_KEY, JSON.stringify({
                        completed: true,
                        randomId: generatedRandomId,
                        userInfo: userInfo,
                        feedbackList: feedbackList
                    }));

                    setCurrentStep('result');

                } catch (error) {
                    console.error("Submission Error:", error);
                    setSubmitError("è³‡æ–™å‚³é€å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚");
                } finally {
                    setIsSubmitting(false);
                }
            };

            // --- Render ---

            if (currentStep === 'incognito_blocked') {
                return (
                    <div className="min-h-screen bg-gray-900 flex flex-col items-center justify-center p-6 text-center font-sans">
                        <div className="bg-gray-800 p-8 rounded-3xl border-2 border-red-500 shadow-2xl max-w-md w-full">
                            <div className="text-red-500 mb-6 flex justify-center">
                                <EyeOff size={64} />
                            </div>
                            <h1 className="text-2xl font-bold text-white mb-4">ç„¡æ³•åœ¨ç„¡ç—•æ¨¡å¼ä¸­é€²è¡Œè©•é‡</h1>
                            <p className="text-gray-400">
                                ç³»çµ±åµæ¸¬åˆ°æ‚¨æ­£åœ¨ä½¿ç”¨ã€Œç„¡ç—•æ¨¡å¼ã€æˆ–ã€Œç§å¯†ç€è¦½ã€ã€‚<br/><br/>
                                è«‹é—œé–‰æ­¤è¦–çª—ï¼Œä½¿ç”¨<strong>ä¸€èˆ¬æ¨¡å¼</strong>é‡æ–°é–‹å•Ÿç¶²é ä»¥é€²è¡Œæ¸¬é©—ã€‚
                            </p>
                        </div>
                    </div>
                );
            }

            if (currentStep === 'loading') {
                return <div className="min-h-screen flex items-center justify-center bg-pink-50 text-gray-500 font-medium">âœ¨ æº–å‚™ä¸­...</div>;
            }

            if (currentStep === 'intro') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-pink-100 via-purple-100 to-sky-100 flex items-center justify-center p-4 font-sans">
                        <div className="bg-white/90 backdrop-blur max-w-2xl w-full rounded-[3rem] shadow-xl overflow-hidden border-4 border-white">
                            <div className="bg-rose-400 p-10 text-white text-center relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-20 h-20 bg-white/20 rounded-full -translate-x-10 -translate-y-10"></div>
                                <div className="absolute bottom-0 right-0 w-32 h-32 bg-white/10 rounded-full translate-x-10 translate-y-10"></div>
                                <h1 className="text-3xl font-bold mb-3 tracking-wide drop-shadow-md">ä¹å¹´ç´šè³‡è¨Šç§‘æŠ€</h1>
                                <h2 className="text-xl font-medium opacity-95 flex items-center justify-center gap-2">
                                    <Star className="text-yellow-300 fill-current" size={24}/> æœŸæœ«å­¸ç¿’æˆæœç¸½çµ <Star className="text-yellow-300 fill-current" size={24}/>
                                </h2>
                            </div>
                            <div className="p-10">
                                <div className="space-y-6 text-gray-600">
                                    <p className="text-lg leading-relaxed text-center font-medium">
                                        å—¨ï¼å„ä½åŒå­¸å¥½ ğŸ‘‹ <br/>é€™å€‹å°æ¸¬é©—æ˜¯å›é¡§é€™å­¸æœŸ<span className="text-rose-500 font-bold">ã€Œè³‡æ–™æ•¸ä½åŒ–ã€</span>çš„å­¸ç¿’å…§å®¹ã€‚
                                    </p>
                                    <div className="bg-yellow-50 p-6 rounded-3xl border-2 border-yellow-200 space-y-3 relative">
                                        <div className="absolute -top-3 left-6 bg-yellow-400 text-white px-3 py-1 rounded-full text-sm font-bold shadow-sm">è©•é‡èªªæ˜</div>
                                        <ul className="list-none space-y-3 text-sm text-gray-600 mt-2">
                                            <li className="flex items-center gap-2"><Heart size={16} className="text-rose-400 fill-current" /> é¡Œå‹åªæœ‰ã€Œæ˜¯éé¡Œã€æˆ–ã€ŒäºŒé¸ä¸€ã€ï¼Œè¼•é¬†ä½œç­”ï¼</li>
                                            <li className="flex items-center gap-2"><Cloud size={16} className="text-sky-400 fill-current" /> 
                                                <span className="text-rose-500 font-bold">ä¸åˆ—å…¥æˆç¸¾è¨ˆç®—ï¼Œè€Œæ˜¯ç‚ºäº†äº†è§£ä½ æ˜¯å¦æœ‰å­¸åˆ°èª²ç¨‹ä¸­çš„è§€å¿µ</span>
                                            </li>
                                            <li className="flex items-center gap-2"><Lock size={16} className="text-purple-400 fill-current" /> åªèƒ½å¡«å¯«ä¸€æ¬¡ï¼Œè«‹å‹¿é‡æ–°æ•´ç†é é¢ã€‚</li>
                                        </ul>
                                    </div>
                                    <button onClick={() => setCurrentStep('quiz')} className="w-full bg-sky-400 hover:bg-sky-500 text-white font-bold py-4 px-6 rounded-full transition-all transform hover:scale-[1.03] active:scale-95 flex items-center justify-center gap-2 shadow-lg hover:shadow-sky-200 text-lg">
                                        é–‹å§‹ <ArrowRight size={24} />
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (currentStep === 'quiz') {
                const currentConcept = QUIZ_DATA[currentConceptIndex];
                const currentQuestion = questionSequence[currentQuestionIdx];
                if (!currentConcept || !currentQuestion) return <div className="min-h-screen flex items-center justify-center bg-pink-50">è¼‰å…¥ä¸­...</div>;
                const totalConcepts = QUIZ_DATA.length;
                const progress = ((currentConceptIndex) / totalConcepts) * 100;
                
                // æ±ºå®šè¦é¡¯ç¤ºçš„é¸é …ï¼šé‡è©¦é¡Œç”¨è‡ªå·±çš„ï¼Œæ­£å¸¸é¡Œç”¨å¹³è¡¡éš¨æ©Ÿçš„
                let displayOptions = [];
                if (currentQuestion.isRetry) {
                    displayOptions = currentQuestion.options;
                } else {
                    displayOptions = (sessionOptions[currentQuestion.id]) ? sessionOptions[currentQuestion.id] : currentQuestion.options;
                }

                return (
                    <div className="min-h-screen bg-[#fff8f0] flex items-center justify-center p-4 font-sans">
                        <div className="max-w-xl w-full">
                            <div className="mb-6 bg-white p-3 rounded-full shadow-sm border border-orange-100 flex items-center gap-3">
                                <div className="flex-1 h-3 bg-gray-100 rounded-full overflow-hidden"><div className="h-full bg-gradient-to-r from-rose-300 to-orange-300 transition-all duration-700 ease-out" style={{ width: `${progress}%` }}></div></div>
                                <span className="text-xs font-bold text-orange-400 whitespace-nowrap">{Math.round(progress)}% å®Œæˆ</span>
                            </div>
                            <div className="bg-white rounded-[2rem] shadow-xl border-4 border-white overflow-hidden relative ring-4 ring-orange-50">
                                <div className="bg-amber-100 px-8 py-5 flex items-center gap-3 border-b-2 border-amber-200 border-dashed">
                                    <div className="bg-white p-2 rounded-full text-amber-500 shadow-sm"><BookOpen size={20} /></div>
                                    <span className="font-bold text-amber-800 text-lg">{currentConcept.title}</span>
                                </div>
                                <div className="p-8">
                                    <div className="mb-6">
                                        <span className={`inline-block px-4 py-1.5 rounded-full text-sm font-bold mb-4 shadow-sm ${currentQuestion.type === 'TF' ? 'bg-emerald-100 text-emerald-600' : 'bg-sky-100 text-sky-600'}`}>{currentQuestion.type === 'TF' ? 'â­• âŒ æ˜¯éé¡Œ' : 'ğŸ”¢ é¸æ“‡é¡Œ'}</span>
                                        <h3 className="text-xl font-bold text-gray-700 leading-relaxed tracking-wide">{currentQuestion.text}</h3>
                                    </div>
                                    <div className="grid grid-cols-1 gap-4">
                                        {displayOptions.map((option, idx) => (
                                            <button key={idx} onClick={() => handleAnswer(option)} className="group option-btn relative p-5 text-left bg-gray-50 border-2 border-gray-100 rounded-2xl hover:border-sky-300 hover:bg-sky-50 transition-all duration-300 shadow-sm hover:shadow-md">
                                                <div className="flex items-center justify-between">
                                                    <span className="font-bold text-gray-600 group-hover:text-sky-600 text-lg pl-2">{option}</span>
                                                    <div className="w-8 h-8 rounded-full bg-white border-2 border-gray-200 group-hover:border-sky-400 flex items-center justify-center transition-colors"><div className="w-3 h-3 rounded-full bg-sky-400 opacity-0 group-hover:opacity-100 transition-opacity transform scale-0 group-hover:scale-100"></div></div>
                                                </div>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (currentStep === 'survey') {
                return (
                    <div className="min-h-screen bg-gradient-to-t from-teal-50 to-white flex items-center justify-center p-4 font-sans">
                        <div className="max-w-2xl w-full bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border-4 border-white">
                            <div className="bg-teal-400 p-8 text-white text-center">
                                <h2 className="text-2xl font-bold flex justify-center items-center gap-2"><Smile className="text-yellow-200" /> å­¸ç¿’æ…‹åº¦è‡ªæˆ‘æª¢æ ¸</h2>
                                <p className="opacity-90 mt-2 text-sm font-medium">å›ç­”é€™ä¸‰é¡Œï¼Œå°±å®Œæˆå›‰ï¼</p>
                            </div>
                            <div className="p-8 space-y-8">
                                {SURVEY_QUESTIONS.map((q) => (
                                    <div key={q.id} className="bg-gray-50 p-6 rounded-3xl border border-gray-100">
                                        <h3 className="text-lg font-bold text-gray-700 mb-4 flex items-center gap-3"><div className="bg-white p-2 rounded-full text-teal-500 shadow-sm">{q.icon}</div>{q.text}</h3>
                                        <div className="grid grid-cols-2 gap-3">
                                            {q.options.map((opt) => (
                                                <button key={opt} onClick={() => handleSurveyAnswer(q.id, opt)} className={`py-3 px-4 rounded-xl text-sm font-bold transition-all ${surveyAnswers[q.id] === opt ? 'bg-teal-500 text-white shadow-lg scale-105' : 'bg-white text-gray-500 border border-gray-200 hover:border-teal-300 hover:text-teal-600'}`}>{opt}</button>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                                <button onClick={finishSurvey} className="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-4 px-6 rounded-2xl shadow-lg transition-transform hover:-translate-y-1 text-lg flex items-center justify-center gap-2">å®Œæˆä¸¦é€å‡º <ArrowRight /></button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (currentStep === 'submission') {
                return (
                    <div className="min-h-screen bg-gradient-to-t from-violet-100 to-white flex items-center justify-center p-4 font-sans">
                        <div className="max-w-md w-full bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border-4 border-white">
                            <div className="bg-violet-400 p-8 text-white text-center">
                                <h2 className="text-2xl font-bold flex justify-center items-center gap-2"><Award className="text-yellow-300" /> æ­å–œå®Œæˆï¼</h2>
                                <p className="opacity-90 mt-2 text-sm font-medium">å¡«å¯«ç­ç´šåº§è™Ÿï¼ŒæŸ¥çœ‹ä½ çš„æˆæœå¡ âœ¨</p>
                            </div>
                            <div className="p-8">
                                <form onSubmit={handleSubmit} className="space-y-5">
                                    <div>
                                        <label className="block text-sm font-bold text-gray-500 mb-2 ml-2">ç­ç´š (ä¹å¹´ç´š)</label>
                                        <div className="relative">
                                            <select value={userInfo.className} onChange={(e) => setUserInfo({...userInfo, className: e.target.value})} className="w-full p-4 bg-gray-50 border-2 border-gray-100 rounded-2xl appearance-none focus:ring-4 focus:ring-violet-100 focus:border-violet-300 outline-none text-lg text-gray-700 transition-all font-medium">
                                                {[...Array(10)].map((_, i) => <option key={i+1} value={String(i+1)}>{i+1} ç­</option>)}
                                            </select>
                                            <div className="absolute right-4 top-1/2 transform -translate-y-1/2 pointer-events-none text-gray-400">â–¼</div>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-500 mb-2 ml-2">åº§è™Ÿ</label>
                                        <input type="number" min="1" max="50" placeholder="è«‹è¼¸å…¥è™Ÿç¢¼..." value={userInfo.seatNumber} onChange={(e) => setUserInfo({...userInfo, seatNumber: e.target.value})} className="w-full p-4 bg-gray-50 border-2 border-gray-100 rounded-2xl focus:ring-4 focus:ring-violet-100 focus:border-violet-300 outline-none text-lg text-gray-700 transition-all font-medium placeholder-gray-300" required />
                                    </div>
                                    {submitError && <div className="p-4 bg-rose-50 text-rose-500 rounded-2xl text-sm flex items-center gap-2 border border-rose-100"><AlertCircle size={18}/> {submitError}</div>}
                                    {!GOOGLE_SCRIPT_URL && <div className="p-3 bg-amber-50 text-amber-600 rounded-xl text-xs text-center border border-amber-100">âš ï¸ æ¨¡æ“¬æ¨¡å¼ï¼šè³‡æ–™ä¸æœƒå¯¦éš›ä¸Šå‚³</div>}
                                    <button type="submit" disabled={isSubmitting} className={`w-full py-4 px-6 rounded-2xl font-bold text-white shadow-lg flex items-center justify-center gap-2 transition-all mt-4 ${isSubmitting ? 'bg-gray-300 cursor-not-allowed' : 'bg-violet-400 hover:bg-violet-500 hover:shadow-violet-200 hover:-translate-y-1'}`}>
                                        {isSubmitting ? 'å‚³é€ä¸­...' : 'é€å‡ºä¸¦æŸ¥çœ‹çµæœ'} {!isSubmitting && <Send size={18} />}
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                );
            }

            if (currentStep === 'result') {
                const displayFeedback = (storedFeedback && storedFeedback.length > 0) ? storedFeedback : generateFeedbackData();

                return (
                    <div className="min-h-screen bg-[#f8fafc] p-4 font-sans relative">
                        {showDuplicateModal && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
                                <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-sm w-full text-center border-4 border-yellow-200" style={{animation: 'slideIn 0.4s ease-out'}}>
                                    <div className="inline-flex items-center justify-center w-16 h-16 bg-yellow-100 text-yellow-600 rounded-full mb-4"><Info size={32} /></div>
                                    <h3 className="text-xl font-bold text-gray-800 mb-2">æº«é¦¨æé†’</h3>
                                    <p className="text-gray-600 mb-6 font-medium">æ‚¨å·²ç¶“å®Œæˆéè©•é‡å›‰ï¼<br/>è«‹å°‡çµæœæˆªåœ–ä¸Šå‚³å³å¯ï¼Œ<br/><span className="text-rose-500 font-bold">ä¸éœ€é‡è¤‡ä½œç­”</span>ã€‚</p>
                                    <button onClick={() => setShowDuplicateModal(false)} className="w-full bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-3 px-6 rounded-xl transition-transform hover:scale-105 shadow-md flex items-center justify-center gap-2">æˆ‘çŸ¥é“äº† <CheckCircle size={18} /></button>
                                </div>
                            </div>
                        )}
                        <div className="max-w-3xl mx-auto space-y-6">
                            <div className="bg-white rounded-[2rem] shadow-xl overflow-hidden border-4 border-white relative">
                                {alreadyCompleted && <div className="bg-amber-100 text-amber-700 text-center py-2 text-sm font-bold flex items-center justify-center gap-2"><Lock size={14}/> æ‚¨å·²å®Œæˆæ¸¬é©—</div>}
                                <div className="p-10 text-center bg-gradient-to-b from-green-50 to-white">
                                    <div className="inline-flex items-center justify-center w-20 h-20 bg-green-100 text-green-500 rounded-full mb-5 shadow-sm"><CheckCircle size={40} /></div>
                                    <h2 className="text-3xl font-extrabold text-gray-700 mb-2 tracking-tight">{userInfo.className ? `ä¹å¹´ ${userInfo.className} ç­ ${userInfo.seatNumber} è™Ÿ` : 'æ¸¬é©—å®Œæˆ'}</h2>
                                    <p className="text-gray-400 text-sm font-medium">åšå¾—å¥½ï¼ä»¥ä¸‹æ˜¯ä½ çš„å­¸ç¿’åˆ†æ</p>
                                    <div className="flex flex-col items-center justify-center mt-6 p-6 bg-white rounded-3xl w-full max-w-xs mx-auto border-2 border-dashed border-gray-200 shadow-inner">
                                        <span className="text-gray-400 text-xs uppercase tracking-widest font-bold mb-1">æ‚¨çš„å°ˆå±¬è­˜åˆ¥ç¢¼</span>
                                        <span className="text-4xl font-mono font-bold text-sky-500 tracking-widest">{randomId}</span>
                                        <span className="text-xs text-rose-400 mt-2 font-medium bg-rose-50 px-3 py-1 rounded-full">è«‹æˆªåœ–æ•´å€‹å¤§æ¡†æ¡†çš„ç¯„åœ</span>
                                    </div>
                                </div>
                            </div>
                            {displayFeedback.map((item, index) => (
                                <div key={index} className={`bg-white rounded-[2rem] shadow-sm p-8 border-4 transition-transform hover:scale-[1.01] duration-300 ${item.level === 'A' ? 'border-emerald-100' : item.level === 'B' ? 'border-sky-100' : 'border-orange-50'}`}>
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className={`text-xl font-bold flex items-center gap-2 ${item.level === 'A' ? 'text-emerald-600' : item.level === 'B' ? 'text-sky-600' : 'text-orange-400'}`}>{item.level === 'A' && <Star className="fill-current" size={20}/>} {item.title}</h3>
                                        {!isDuplicate && item.level && item.level !== 'C' && <span className={`px-4 py-1.5 rounded-full text-sm font-bold shadow-sm ${item.level === 'A' ? 'bg-emerald-100 text-emerald-600' : 'bg-sky-100 text-sky-600'}`}>è¡¨ç¾ç­‰ç´šï¼š{item.level}</span>}
                                    </div>
                                    <p className="text-gray-600 leading-relaxed text-justify whitespace-pre-wrap font-medium">{item.text}</p>
                                </div>
                            ))}
                            <div className="bg-gradient-to-r from-violet-300 to-fuchsia-300 rounded-[2rem] shadow-lg p-8 text-white relative overflow-hidden">
                                <div className="absolute top-0 right-0 w-40 h-40 bg-white/10 rounded-full translate-x-10 -translate-y-10 blur-xl"></div>
                                <h3 className="text-xl font-bold mb-4 flex items-center gap-2 relative z-10"><Award size={24} className="text-yellow-200" /> è€å¸«çš„è©±</h3>
                                <p className="leading-relaxed font-medium relative z-10 text-white/95">
                                    {isDuplicate 
                                        ? "ç³»çµ±åµæ¸¬åˆ°æ‚¨å·²å®Œæˆéæ¸¬é©—ã€‚æ­¤ç‚ºé‡è¤‡ä½œç­”ç´€éŒ„ï¼Œåƒ…ä¾›åƒè€ƒï¼Œä¸åˆ—å…¥æˆç¸¾è¨ˆç®—ã€‚" 
                                        : "åœ¨ä¹å¹´ç´šé€™å€‹éšæ®µï¼Œæˆ‘å€‘å¸Œæœ›ä½ å­¸åˆ°çš„ä¸åªæ˜¯ã€Œç®—å°æ•¸å­¸é¡Œã€ï¼Œè€Œæ˜¯èƒ½é€£çµçœŸå¯¦ä¸–ç•Œã€‚\nå¸Œæœ›ä½ ç¾åœ¨å·²ç¶“æ‡‚å¾—ç‚ºä»€éº¼ 3 åˆ†é˜çš„æœªå£“ç¸®éŒ„éŸ³æª”æœƒé€™éº¼å¤§ï¼Œä»¥åŠç‚ºä»€éº¼æˆ‘å€‘éœ€è¦ MP3 æ ¼å¼ä¾†å£“ç¸®å®ƒã€‚æœŸå¾…é€™é–€èª²èƒ½å¹«åŠ©ä½ äº†è§£ç”Ÿæ´»ä¸­çš„æ•¸ä½ç§‘æŠ€ï¼Œå…¶å¯¦éƒ½æºè‡ªæ–¼é€™äº› 0 èˆ‡ 1 çš„åŸºç¤åŸç†ï¼"
                                    }
                                </p>
                            </div>
                            <div className="text-center text-gray-400 text-xs py-6 font-medium">è©•é‡çµæŸï¼Œè«‹ä¾ä¸Šæ–¹èªªæ˜é€²è¡Œæˆªåœ–ä¸Šå‚³</div>
                        </div>
                    </div>
                );
            }

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AssessmentApp />);
    </script>
</body>
</html>